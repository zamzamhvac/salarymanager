<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PM's Salary Manager - Digital Munshi</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Firebase Libraries (already included) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-auth-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-database-compat.min.js"></script>
    <style>
        :root {
            --primary-color: #6200EE;
            --primary-variant-color: #3700B3;
            --secondary-color: #03DAC6;
            --background-color: #f5f5f5;
            --surface-color: #FFFFFF;
            --on-primary-color: #FFFFFF;
            --on-surface-color: #000000;
            --error-color: #B00020;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Roboto', sans-serif; background-color: var(--background-color); color: var(--on-surface-color); }
        .header { background-color: var(--primary-color); color: var(--on-primary-color); padding: 0 16px; height: 64px; display: flex; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2); position: fixed; top: 0; left: 0; right: 0; z-index: 1000; }
        .header h1 { font-size: 20px; font-weight: 500; margin-left: 16px; }
        .menu-icon { cursor: pointer; padding: 8px; border-radius: 50%; transition: background-color 0.3s; }
        .menu-icon:hover { background-color: rgba(255,255,255,0.1); }
        #userInfo { margin-left: auto; display: none; align-items: center; }
        #userName { font-size: 14px; }
        .side-nav { position: fixed; top: 0; left: -300px; width: 280px; height: 100%; background-color: var(--surface-color); box-shadow: 2px 0 5px rgba(0,0,0,0.2); z-index: 1100; transition: left 0.3s ease-in-out; display: flex; flex-direction: column; }
        .side-nav.open { left: 0; }
        .nav-header { padding: 16px; background-color: var(--primary-variant-color); color: var(--on-primary-color); }
        .nav-header h2 { font-size: 18px; font-weight: 500; }
        .nav-header p { font-size: 12px; opacity: 0.8; }
        .nav-buttons-container { list-style: none; padding-top: 8px; flex-grow: 1; overflow-y: auto; }
        .nav-btn { display: flex; align-items: center; padding: 12px 16px; cursor: pointer; transition: background-color 0.3s; border: none; background: none; width: 100%; text-align: left; font-size: 14px; color: var(--on-surface-color); }
        .nav-btn .material-icons { margin-right: 24px; color: #5f6368; }
        .nav-btn:hover { background-color: rgba(0,0,0,0.05); }
        .nav-btn.active { background-color: rgba(98, 0, 238, 0.08); color: var(--primary-color); font-weight: 500; }
        .nav-btn.active .material-icons { color: var(--primary-color); }
        #main-content { padding: 76px 16px 16px 16px; width: 100%; }
        .page { display: none; background: var(--surface-color); padding: 16px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24); }
        .page.active { display: block; }
        .page > h2 { font-size: 20px; font-weight: 500; margin-bottom: 4px; color: var(--primary-color); }
        .page > p { margin-bottom: 12px; font-size: 14px; color: rgba(0,0,0,0.6); }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 4px; font-weight: 500; font-size: 14px; color: #4a5568; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(98, 0, 238, 0.2); }
        .btn { background-color: var(--primary-color); color: var(--on-primary-color); border: none; padding: 10px 16px; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 500; text-transform: uppercase; box-shadow: 0 2px 2px 0 rgba(0,0,0,0.14), 0 3px 1px -2px rgba(0,0,0,0.12), 0 1px 5px 0 rgba(0,0,0,0.2); transition: all 0.2s; margin: 4px; outline: none; display: inline-flex; align-items: center; justify-content: center; }
        .btn:hover { background-color: var(--primary-variant-color); box-shadow: 0 3px 3px 0 rgba(0,0,0,0.14), 0 1px 7px 0 rgba(0,0,0,0.12), 0 3px 1px -1px rgba(0,0,0,0.2); }
        .btn-danger { background-color: var(--error-color); }
        .btn-danger:hover { background-color: #9a001b; }
        .btn-success { background-color: #00C853; }
        .btn-success:hover { background-color: #00b048; }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1050; }
        .overlay.open { display: block; }
        .worker-checkbox { display: flex; align-items: center; margin: 0; padding: 8px; background: #f7fafc; border-radius: 4px; border: 1px solid #eee;}
        .worker-checkbox input { width: auto; margin-right: 8px; }
        .alert { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 15px 25px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 9999; opacity: 0; transition: opacity 0.5s ease, bottom 0.5s ease; font-weight: 500; display: flex; align-items: center; }
        .alert.show { opacity: 1; bottom: 30px; }
        .alert-success { background: #c6f6d5; color: #22543d; border-left: 5px solid #38a169; }
        .alert-error { background: #fed7d7; color: #742a2a; border-left: 5px solid #c53030; }
        .alert-info { background: #bee3f8; color: #2a4365; border-left: 5px solid #3182ce; }
        .loading { text-align: center; padding: 20px; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 2s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #daily-entry-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        #daily-entry-left, #daily-entry-right { display: flex; flex-direction: column; }
        #daily-entry-right h3 { font-size: 16px; font-weight: 500; margin-bottom: 8px; }
        #workerAttendance { flex-grow: 1; overflow-y: auto; display: grid; gap: 8px; grid-template-columns: 1fr; padding-right: 8px; max-height: 230px; border: 1px solid #eee; padding: 8px; border-radius: 4px; }
        .action-buttons { margin-top: auto; padding-top: 16px; text-align: center; }
        .action-buttons .btn { width: 90%; max-width: 300px; }
        @media (max-width: 768px) { 
            #daily-entry-layout { grid-template-columns: 1fr; } 
            #workerAttendance { max-height: 180px; } 
        }
        .two-column { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        @media (max-width: 768px) {
            .two-column { grid-template-columns: 1fr; }
        }
        .agreement-section { background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0; border: 1px solid #e9ecef; }
        .agreement-section h3 { color: #495057; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #dee2e6; }
        .rate-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .report-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .report-card { background: #f7fafc; padding: 20px; border-radius: 8px; margin: 10px 0; border-left: 4px solid var(--primary-color); }
        .history-selector-container { margin-top: 24px; padding: 16px; border: 1px solid #e0e0e0; border-radius: 8px; background: #fafafa; }
        .history-table-container { margin-top: 16px; }
        .history-table-wrapper { overflow-x: auto; }
        .history-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .history-table th, .history-table td { padding: 8px; border: 1px solid #ddd; text-align: left; }
        .history-table th { background-color: #f2f2f2; }
        .history-table tr:nth-child(even) { background-color: #f9f9f9; }
        .no-history { color: #777; font-style: italic; }
        .settings-section { margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; }
        .checkbox-group { display: flex; align-items: center; margin-bottom: 16px; }
        .checkbox-group input { width: auto; margin-right: 10px; }
        .sub-setting { padding-left: 30px; }
        
        /* MODIFIED: Setup Wizard Styles for Responsiveness */
        #setup-wizard-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; align-items: center; justify-content: center; padding: 15px; }
        .wizard-container { background: #fff; padding: 25px; border-radius: 10px; max-width: 600px; width: 100%; box-shadow: 0 5px 15px rgba(0,0,0,0.3); max-height: 90vh; display: flex; flex-direction: column; }
        .wizard-step { display: none; }
        .wizard-step.active { display: block; }
        .wizard-container h2 { font-size: 22px; color: var(--primary-color); margin-bottom: 10px; text-align: center; }
        .wizard-container p { text-align: center; margin-bottom: 20px; color: #555; font-size: 15px;}
        .wizard-body { overflow-y: auto; padding-right: 15px; margin-bottom: 20px; max-height: 60vh; }
        .wizard-nav { display: flex; justify-content: space-between; align-items: center; padding-top: 15px; border-top: 1px solid #eee; }
        .wizard-warning { background-color: #fffbe6; border-left: 4px solid #f59e0b; padding: 12px; margin-bottom: 15px; font-size: 14px; }
        
        @media (max-width: 600px) {
            .wizard-container { padding: 15px; max-height: 95vh; }
            .wizard-container h2 { font-size: 20px; }
            .wizard-container p { font-size: 14px; }
            .wizard-body { max-height: calc(95vh - 200px); } /* Adjust height for smaller screens */
            .rate-grid { grid-template-columns: 1fr; } /* Stack agreement inputs on small screens */
            .wizard-nav .btn { padding: 8px 12px; font-size: 13px; }
        }
    </style>
</head>
<body>
    <!-- Header, Nav, Overlay -->
    <header class="header" id="appHeader" style="display:none;"><i class="material-icons menu-icon" onclick="toggleNav()">menu</i><h1>üèóÔ∏è PM's Salary Manager</h1><div id="userInfo"><span id="userName"></span><button onclick="signOut()" class="btn btn-danger" style="padding: 5px 10px; font-size: 12px; margin-left: 8px;">Sign Out</button></div></header>
    <nav class="side-nav" id="sideNav"><div class="nav-header"><h2>Digital Munshi</h2><p>Your Payroll Assistant</p></div><ul class="nav-buttons-container" id="navButtons"><li><button class="nav-btn" data-page="daily-entry"><i class="material-icons">edit_calendar</i> Daily Entry</button></li><li><button class="nav-btn" data-page="agreements"><i class="material-icons">gavel</i> Agreements</button></li><li><button class="nav-btn" data-page="salaries"><i class="material-icons">payments</i> Salaries</button></li><li><button class="nav-btn" data-page="bonus"><i class="material-icons">emoji_events</i> Bonus</button></li><li><button class="nav-btn" data-page="arrears"><i class="material-icons">calculate</i> Arrears</button></li><li><button class="nav-btn" data-page="leaves"><i class="material-icons">beach_access</i> Leaves</button></li><li><button class="nav-btn" data-page="settings"><i class="material-icons">settings</i> Settings</button></li></ul></nav>
    <div class="overlay" id="overlay" onclick="toggleNav()"></div>

    <main id="main-content">
        <!-- Login Page -->
        <div id="login-page" class="page active"><h2>Welcome to PM's Salary Manager</h2><p>Please sign in to continue</p><div class="form-group"><label>Email:</label><input type="email" id="loginEmail" placeholder="Enter your email"></div><div class="form-group"><label>Password:</label><input type="password" id="loginPassword" placeholder="Enter your password"></div><button onclick="signIn()" class="btn">Sign In</button><button onclick="showSignUp()" class="btn btn-success">Create New Account</button><div id="signUpForm" style="display: none; margin-top: 30px; padding-top: 30px; border-top: 2px solid #eee;"><h3>Create New Account</h3><div class="form-group"><label>Email:</label><input type="email" id="signupEmail" placeholder="Enter your email"></div><div class="form-group"><label>Password:</label><input type="password" id="signupPassword" placeholder="Choose a password (min 6 characters)"></div><div class="form-group"><label>Company/Business Name:</label><input type="text" id="companyName" placeholder="Enter your business name"></div><button onclick="signUp()" class="btn btn-success">Create Account</button><button onclick="hideSignUp()" class="btn">Back to Sign In</button></div></div>

        <!-- Daily Entry Page -->
        <div id="daily-entry" class="page">
            <h2>üìù Daily Entry</h2>
            <p>Record today's work details and attendance.</p>
            <div id="daily-entry-layout">
                <div id="daily-entry-left">
                    <div class="form-group"><label>Date:</label><input type="date" id="entryDate"></div>
                    <div class="form-group"><label>Day Type:</label><select id="dayType"><option value="work">Work Day</option><option value="rest">Rest Day</option><option value="special_overtime">Special Overtime</option></select></div>
                    <div id="workDetails">
                        <div class="form-group"><label>Total Tonnage:</label><input type="number" id="tonnage" step="0.1" placeholder="e.g., 150.5"></div>
                        <div class="form-group" id="wagons-input-container"><label>Total Wagons:</label><input type="number" id="wagons" placeholder="e.g., 5"></div>
                    </div>
                    <div class="action-buttons">
                        <button onclick="saveDailyEntry()" class="btn">Save Entry</button>
                    </div>
                </div>
                <div id="daily-entry-right">
                    <h3>Worker Attendance</h3>
                    <div id="workerAttendance"><div class="loading"><p>Loading workers...</p></div></div>
                </div>
            </div>
            <div class="history-selector-container">
                <div class="form-group">
                    <label for="historyPeriodSelector">Select History Period:</label>
                    <select id="historyPeriodSelector" onchange="updateHistoryDisplay()"></select>
                </div>
            </div>
            <div id="entryResults"></div>
        </div>
        
        <!-- All Other Pages -->
        <div id="agreements" class="page"><h2>üìã Agreements Management</h2><p>Manage current and new agreement rates</p><div class="two-column"><div class="agreement-section"><h3>Current Agreement</h3><div class="rate-grid"><div class="form-group"><label>Ton Rate (Rs):</label><input type="number" id="currentTonRate"></div><div class="form-group"><label>Rest Rate (Rs):</label><input type="number" id="currentRestRate"></div><div class="form-group"><label>Layoff Rate (Rs):</label><input type="number" id="currentLayoffRate"></div><div class="form-group wagon-rate-field"><label>Wagon Rate (Rs):</label><input type="number" id="currentWagonRate"></div><div class="form-group"><label>Monthly Allowance (Rs):</label><input type="number" id="currentAllowance"></div><div class="form-group"><label>Annual Benefits (Rs):</label><input type="number" id="currentAnnualBenefits"></div></div></div><div class="agreement-section"><h3>New Agreement</h3><div class="rate-grid"><div class="form-group"><label>Ton Rate (Rs):</label><input type="number" id="newTonRate"></div><div class="form-group"><label>Rest Rate (Rs):</label><input type="number" id="newRestRate"></div><div class="form-group"><label>Layoff Rate (Rs):</label><input type="number" id="newLayoffRate"></div><div class="form-group wagon-rate-field"><label>Wagon Rate (Rs):</label><input type="number" id="newWagonRate"></div><div class="form-group"><label>Monthly Allowance (Rs):</label><input type="number" id="newAllowance"></div><div class="form-group"><label>Annual Benefits (Rs):</label><input type="number" id="newAnnualBenefits"></div></div></div></div><button onclick="saveAgreements()" class="btn">Save Agreements</button></div>
        <div id="salaries" class="page"><h2>üí∞ Salary Reports</h2><p>View salary reports for different pay periods</p><div class="form-group"><label>Select Pay Period:</label><select id="payPeriod"><option value="">Select Period</option></select></div><button onclick="generateSalaryReport()" class="btn">Generate Report</button><div id="salaryResults"></div></div>
        <div id="bonus" class="page"><h2>üéÅ Annual Bonus & Gratuity</h2><p>Calculate annual bonus, gratuity and paid leaves bonus</p><div class="form-group"><label>Select Fiscal Year:</label><select id="fiscalYear"><option value="">Select Year</option></select></div><button onclick="calculateBonus()" class="btn">Calculate Bonus</button><div id="bonusResults"></div></div>
        <div id="arrears" class="page"><h2>üìä Arrears Calculation</h2><p>Calculate pending arrears based on agreement differences</p><button onclick="calculateArrears()" class="btn">Calculate Automatic Arrears</button><div id="arrearsResults"></div></div>
        <div id="leaves" class="page"><h2>üèñÔ∏è Leaves Report</h2><p>Track annual leaves for all workers</p><div class="form-group"><label>Select Fiscal Year:</label><select id="leavesFiscalYear"><option value="">Select Year</option></select></div><button onclick="generateLeavesReport()" class="btn">Generate Leaves Report</button><div id="leavesResults"></div></div>
        <div id="settings" class="page">
            <h2>‚öôÔ∏è Settings</h2><p>Configure your application settings</p>
            <h3>General Settings</h3>
            <div class="form-group"><label>Number of Workers:</label><input type="number" id="workerCount" placeholder="8" disabled></div>
            <div class="form-group"><label>Agreement Start Date:</label><input type="date" id="agreementStartDate"></div>
            <div class="form-group"><label>Fiscal Year Start (MM-DD):</label><input type="text" id="fiscalYearStart" placeholder="10-10" pattern="[0-9]{2}-[0-9]{2}"></div>
            
            <div class="settings-section">
                <h3>Feature Controls</h3>
                <div class="checkbox-group">
                    <input type="checkbox" id="enableWagonRate">
                    <label for="enableWagonRate">Enable Wagon Rate Calculation</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="enablePenalty">
                    <label for="enablePenalty">Enable Excess Leave Penalty</label>
                </div>
                <div class="sub-setting" id="penaltyAmountContainer" style="display: none;">
                    <div class="form-group">
                        <label for="penaltyAmount">Penalty Amount (Normal Day)</label>
                        <input type="number" id="penaltyAmount">
                    </div>
                </div>
            </div>

            <div class="settings-section" id="manageWorkersSection">
                <h3>Manage Workers</h3>
                <p class="wizard-warning">Worker names can only be set once during the initial setup wizard.</p>
                <div id="workersList"></div>
            </div>
            <button onclick="saveSettings()" class="btn">Save Settings</button>
        </div>
    </main>

    <!-- MODIFIED: Setup Wizard HTML with Back buttons -->
    <div id="setup-wizard-overlay">
        <div class="wizard-container">
            <!-- Step 1: Worker Count -->
            <div id="wizard-step-1" class="wizard-step">
                <h2>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Step 1: Team Size</h2>
                <p>Aap ki team mein kitne workers hain?</p>
                <div class="wizard-body">
                    <div class="form-group">
                        <label for="wizardWorkerCount">Total Workers</label>
                        <input type="number" id="wizardWorkerCount" placeholder="e.g., 8">
                    </div>
                </div>
                <div class="wizard-nav">
                    <span></span> <!-- for alignment -->
                    <button onclick="wizardNext(1)" class="btn">Next</button>
                </div>
            </div>

            <!-- Step 2: Worker Names -->
            <div id="wizard-step-2" class="wizard-step">
                <h2>üìù Step 2: Worker Names</h2>
                <p>Ab apne tamam workers ke naam darj karen.</p>
                <div class="wizard-warning">
                    <strong>Tawajjuh Farmayen:</strong> Workers ke naam aur unki tarteeb (position) yahan set karne ke baad tabdeel nahi ki ja sakti. Ghalat naam ya tarteeb se future mein hisaab mein masla ho sakta hai.
                </div>
                <div class="wizard-body" id="wizardWorkerNamesContainer">
                    <!-- Worker name inputs will be generated here -->
                </div>
                <div class="wizard-nav">
                    <button onclick="wizardBack(2)" class="btn btn-danger">Back</button>
                    <button onclick="wizardNext(2)" class="btn">Next</button>
                </div>
            </div>

            <!-- Step 3: Agreement Details -->
            <div id="wizard-step-3" class="wizard-step">
                <h2>ü§ù Step 3: Agreement Details</h2>
                <p>Apna mojooda (current) agreement ki rates darj karen.</p>
                <div class="wizard-warning">
                    <strong>Zaroori Hidayat:</strong> Agreement ki details bilkul sahi darj karen. Agar aap inko baad mein tabdeel karte hain, to aapko pichhli tamam entries agreement ki shuru ki tareekh se dobara karni par sakti hain takay hisaab durust ho.
                </div>
                <div class="wizard-body rate-grid">
                    <div class="form-group"><label>Ton Rate (Rs):</label><input type="number" id="wizardTonRate" placeholder="0"></div>
                    <div class="form-group"><label>Rest Rate (Rs):</label><input type="number" id="wizardRestRate" placeholder="0"></div>
                    <div class="form-group"><label>Layoff Rate (Rs):</label><input type="number" id="wizardLayoffRate" placeholder="0"></div>
                    <div class="form-group"><label>Wagon Rate (Rs):</label><input type="number" id="wizardWagonRate" placeholder="0"></div>
                    <div class="form-group"><label>Monthly Allowance (Rs):</label><input type="number" id="wizardAllowance" placeholder="0"></div>
                    <div class="form-group"><label>Annual Benefits (Rs):</label><input type="number" id="wizardAnnualBenefits" placeholder="0"></div>
                </div>
                <div class="wizard-nav">
                    <button onclick="wizardBack(3)" class="btn btn-danger">Back</button>
                    <button onclick="wizardNext(3)" class="btn">Next</button>
                </div>
            </div>

            <!-- Step 4: Agreement Start Date -->
            <div id="wizard-step-4" class="wizard-step">
                <h2>üìÖ Step 4: Agreement Start Date</h2>
                <p>Yeh agreement kis tareekh se shuru hua hai?</p>
                <div class="wizard-body">
                    <div class="form-group">
                        <label for="wizardAgreementStartDate">Agreement Start Date</label>
                        <input type="date" id="wizardAgreementStartDate">
                    </div>
                </div>
                <div class="wizard-nav">
                    <button onclick="wizardBack(4)" class="btn btn-danger">Back</button>
                    <button onclick="finishWizard()" class="btn btn-success">Finish Setup</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // --- MUKAMMAL JAVASCRIPT CODE ---
		
        let currentUser = null;
        // Default App Data structure. This will be overwritten by data from Firebase.
        let appData = { 
            salaries: {}, 
            workers: [],
            permissions: {
                viewableWorkers: []
            },
            configs: { 
                workerCount: 0, 
                agreementStartDate: '2023-10-10', 
                fiscalYearStart: '10-10', 
                isPenaltyEnabled: false, 
                penaltyAmount: 231, 
                isWagonRateEnabled: false,
                isSetupComplete: false 
            }, 
            agreements: { 
                current: { tonRate: 22, restRate: 1100, layoffRate: 549, wagonRate: 0, allowance: 20000, annualBenefits: 0 }, 
                new: { tonRate: 25, restRate: 1200, layoffRate: 600, wagonRate: 0, allowance: 26000, annualBenefits: 0 } 
            } 
        };
        
        function toggleNav() {
            document.getElementById('sideNav').classList.toggle('open');
            document.getElementById('overlay').classList.toggle('open');
        }

        function showPage(pageId) {
            // NEW: Prevent navigation if setup is not complete
            if (!appData.configs.isSetupComplete && pageId !== 'login-page') {
                showAlert('Please complete the setup wizard first.', 'error');
                return;
            }
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            const activeButton = document.querySelector(`.nav-btn[data-page="${pageId}"]`);
            if (activeButton) activeButton.classList.add('active');
            if (window.innerWidth < 960 && document.getElementById('sideNav').classList.contains('open')) {
                toggleNav();
            }
            // Trigger page-specific load functions
            switch(pageId) {
                case 'daily-entry': 
                    loadWorkerAttendance(); 
                    populateHistorySelector();
                    updateHistoryDisplay();
                    break;
                case 'agreements': loadAgreements(); break;
                case 'salaries': loadPayPeriods(); break;
                case 'bonus': case 'leaves': loadFiscalYears(); break;
                case 'settings': loadSettings(); break;
            }
        }

        // --- AUTHENTICATION & DATA FLOW (FIREBASE) ---

        async function startApp() {
            try {
                // Step 1: Fetch configuration from Netlify Function
                console.log("Configuration fetch karne ki koshish...");
                const response = await fetch('/.netlify/functions/get-config');
                if (!response.ok) {
                    throw new Error('Configuration fetch karne mein masla hua.');
                }
                const firebaseConfig = await response.json();
                console.log("Configuration fetch ho gai.");

                // Step 2: Initialize Firebase with the fetched config
                firebase.initializeApp(firebaseConfig);
                console.log("Firebase initialize ho gaya.");

                // Step 3: Set up the Authentication State Listener
                firebase.auth().onAuthStateChanged(async (user) => {
                    if (user) {
                        console.log("User signed in:", user.uid);
                        currentUser = user;
                        await showMainApp();
                    } else {
                        console.log("User is signed out.");
                        currentUser = null;
                        showLoginPage();
                    }
                });
                
                // --- Initial UI Setup (Listeners) ---
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.addEventListener('click', () => showPage(btn.dataset.page));
                });
                document.getElementById('entryDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('dayType').addEventListener('change', function() {
                    const workDetails = document.getElementById('workDetails');
                    workDetails.style.display = this.value === 'rest' ? 'none' : 'block';
                });
                document.getElementById('enablePenalty').addEventListener('change', (e) => {
                    document.getElementById('penaltyAmountContainer').style.display = e.target.checked ? 'block' : 'none';
                });
                document.getElementById('enableWagonRate').addEventListener('change', (e) => {
                    toggleWagonUIElements(e.target.checked);
                });

            } catch (error) {
                console.error("Application start karne mein error:", error);
                document.getElementById('main-content').innerHTML = `
                    <div class="alert alert-error show">
                        <h2>Application Error</h2>
                        <p>Application configuration load nahi ho saki. Baraye meharbani baad mein try karen.</p>
                    </div>`;
            }
        }
        
        document.addEventListener('DOMContentLoaded', startApp);

        async function showMainApp() {
            document.getElementById('login-page').classList.remove('active');
            
            await loadUserData(); 
            
            // NEW: Check if setup is complete. If not, show wizard.
            if (!appData.configs.isSetupComplete) {
                document.getElementById('appHeader').style.display = 'flex'; // Show header for sign out
                document.getElementById('userInfo').style.display = 'flex';
                document.getElementById('userName').textContent = currentUser.displayName || currentUser.email;
                document.getElementById('sideNav').style.display = 'none'; // Hide nav during setup
                showSetupWizard();
            } else {
                document.getElementById('appHeader').style.display = 'flex';
                document.getElementById('userInfo').style.display = 'flex';
                document.getElementById('sideNav').style.display = 'flex';
                document.getElementById('userName').textContent = currentUser.displayName || currentUser.email;
                setupUI();
                toggleWagonUIElements(appData.configs.isWagonRateEnabled);
                showPage('daily-entry');
            }
        }

        function showLoginPage() {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('login-page').classList.add('active');
            document.getElementById('appHeader').style.display = 'none';
            document.getElementById('sideNav').style.display = 'none';
            if (document.getElementById('sideNav').classList.contains('open')) {
                toggleNav();
            }
        }

        function signIn() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            if (!email || !password) {
                showAlert('Please enter both email and password', 'error');
                return;
            }
            firebase.auth().signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    showAlert('Successfully signed in!', 'success');
                })
                .catch((error) => {
                    console.error("Sign in error:", error);
                    showAlert(error.message, 'error');
                });
        }

        function signUp() {
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const companyName = document.getElementById('companyName').value.trim();
            if (!email || password.length < 6) {
                showAlert('Provide a valid email and a password of at least 6 characters.', 'error');
                return;
            }
            if (!companyName) {
                showAlert('Please enter your Company or Business Name.', 'error');
                return;
            }

            firebase.auth().createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    return user.updateProfile({
                        displayName: companyName
                    }).then(() => {
                        currentUser = user; 
                        return initializeNewUserData();
                    });
                })
                .then(() => {
                    showAlert('Account created successfully! Please complete the setup.', 'success');
                })
                .catch((error) => {
                    console.error("Sign up error:", error);
                    showAlert(error.message, 'error');
                });
        }

        function signOut() {
            firebase.auth().signOut().catch((error) => {
                console.error("Sign out error:", error);
                showAlert(error.message, 'error');
            });
        }

        function showSignUp() { document.getElementById('signUpForm').style.display = 'block'; }
        function hideSignUp() { document.getElementById('signUpForm').style.display = 'none'; }
        
        // --- FIREBASE DATABASE FUNCTIONS ---

        async function loadUserData() {
            if (!currentUser) return;
            const userRef = firebase.database().ref('users/' + currentUser.uid);
            try {
                const snapshot = await userRef.once('value');
                if (snapshot.exists()) {
                    const savedData = snapshot.val();
                    appData = {
                        ...appData,
                        ...savedData,
                        permissions: {
                            ...(appData.permissions || {}),
                            ...(savedData.permissions || {})
                        },
                        configs: {
                            ...appData.configs,
                            ...(savedData.configs || {})
                        },
                        agreements: {
                            current: { ...appData.agreements.current, ...(savedData.agreements?.current || {}) },
                            new: { ...appData.agreements.new, ...(savedData.agreements?.new || {}) }
                        },
                        salaries: savedData.salaries || {},
                        workers: savedData.workers || []
                    };
                    
                    if (!appData.permissions.viewableWorkers || appData.permissions.viewableWorkers.length === 0) {
                        if (appData.workers && appData.workers.length > 0) {
                            appData.permissions.viewableWorkers = appData.workers; 
                        } else {
                            appData.permissions.viewableWorkers = [];
                        }
                    }

                    console.log("User data loaded from Firebase.");
                } else {
                    console.log("No data found, initializing new user data in Firebase.");
                    await initializeNewUserData();
                }
            } catch (error) {
                console.error("Error loading user data:", error);
                showAlert("Could not load your data from the server.", "error");
            }
        }
        
        async function saveUserData() {
            if (!currentUser) return;
            try {
                await firebase.database().ref('users/' + currentUser.uid).set(appData);
                console.log("User data saved to Firebase.");
            } catch (error) {
                console.error("Error saving user data:", error);
                showAlert("Failed to save data. Please check your connection.", "error");
            }
        }

        async function initializeNewUserData() {
            appData = { 
                salaries: {}, 
                workers: [], 
                permissions: {
                    viewableWorkers: [] 
                },
                configs: { 
                    workerCount: 0, 
                    agreementStartDate: new Date().toISOString().split('T')[0], 
                    fiscalYearStart: '10-10', 
                    isPenaltyEnabled: false, 
                    penaltyAmount: 231, 
                    isWagonRateEnabled: false,
                    isSetupComplete: false
                }, 
                agreements: { 
                    current: { tonRate: 0, restRate: 0, layoffRate: 0, wagonRate: 0, allowance: 0, annualBenefits: 0 }, 
                    new: { tonRate: 0, restRate: 0, layoffRate: 0, wagonRate: 0, allowance: 0, annualBenefits: 0 } 
                }
            };
            await saveUserData();
        }

        // --- NEW/MODIFIED: SETUP WIZARD FUNCTIONS ---
        function showSetupWizard() {
            document.querySelectorAll('.wizard-step').forEach(s => s.classList.remove('active'));
            const overlay = document.getElementById('setup-wizard-overlay');
            overlay.style.display = 'flex';
            document.getElementById('wizard-step-1').classList.add('active');
        }

        function wizardNext(currentStep) {
            // Validation
            if (currentStep === 1) {
                const count = parseInt(document.getElementById('wizardWorkerCount').value);
                if (!count || count <= 0) {
                    showAlert('Please enter a valid number of workers.', 'error');
                    return;
                }
                // Generate worker name inputs for the next step
                const container = document.getElementById('wizardWorkerNamesContainer');
                container.innerHTML = '';
                for (let i = 0; i < count; i++) {
                    container.innerHTML += `<div class="form-group"><label>Worker ${i + 1} Name:</label><input type="text" class="wizard-worker-name" value="Worker ${i + 1}"></div>`;
                }
            } else if (currentStep === 2) {
                const names = Array.from(document.querySelectorAll('.wizard-worker-name')).map(input => input.value.trim());
                if (names.some(name => name === '')) {
                    showAlert('Please provide a name for every worker.', 'error');
                    return;
                }
            } else if (currentStep === 3) {
                 const tonRate = document.getElementById('wizardTonRate').value;
                 if(tonRate === '' || parseFloat(tonRate) < 0) {
                     showAlert('Please enter a valid Ton Rate.', 'error');
                     return;
                 }
            }

            document.getElementById(`wizard-step-${currentStep}`).classList.remove('active');
            document.getElementById(`wizard-step-${currentStep + 1}`).classList.add('active');
        }

        function wizardBack(currentStep) {
            document.getElementById(`wizard-step-${currentStep}`).classList.remove('active');
            document.getElementById(`wizard-step-${currentStep - 1}`).classList.add('active');
        }

        async function finishWizard() {
            // Final Validation
            const agreementDate = document.getElementById('wizardAgreementStartDate').value;
            if (!agreementDate) {
                showAlert('Please select the agreement start date.', 'error');
                return;
            }

            // Collect all data from wizard
            appData.configs.workerCount = parseInt(document.getElementById('wizardWorkerCount').value);
            appData.workers = Array.from(document.querySelectorAll('.wizard-worker-name')).map(input => input.value.trim());
            appData.permissions.viewableWorkers = [...appData.workers];

            appData.agreements.current.tonRate = parseFloat(document.getElementById('wizardTonRate').value) || 0;
            appData.agreements.current.restRate = parseFloat(document.getElementById('wizardRestRate').value) || 0;
            appData.agreements.current.layoffRate = parseFloat(document.getElementById('wizardLayoffRate').value) || 0;
            appData.agreements.current.wagonRate = parseFloat(document.getElementById('wizardWagonRate').value) || 0;
            appData.agreements.current.allowance = parseFloat(document.getElementById('wizardAllowance').value) || 0;
            appData.agreements.current.annualBenefits = parseFloat(document.getElementById('wizardAnnualBenefits').value) || 0;
            
            appData.configs.agreementStartDate = agreementDate;
            appData.configs.isSetupComplete = true; // Mark setup as complete

            // Save data to Firebase
            await saveUserData();

            // Hide wizard and setup the main app UI
            document.getElementById('setup-wizard-overlay').style.display = 'none';
            showAlert('Setup complete! Welcome.', 'success');
            
            // Reload the main app view
            showMainApp();
        }

        // --- UI and OTHER FUNCTIONS ---
        
        function toggleWagonUIElements(isEnabled) {
            const displayStyle = isEnabled ? 'block' : 'none';
            document.getElementById('wagons-input-container').style.display = displayStyle;
            document.querySelectorAll('.wagon-rate-field').forEach(el => el.style.display = displayStyle);
        }

        function setupUI() { loadWorkerAttendance(); loadAgreements(); loadPayPeriods(); loadFiscalYears(); loadSettings(); }
        
        function loadWorkerAttendance() {
            const container = document.getElementById('workerAttendance');
            container.innerHTML = '';
            if(!appData.workers || appData.workers.length === 0){
                container.innerHTML = "<p>No workers found. Please complete the setup wizard.</p>"; return;
            }
            appData.workers.forEach(worker => {
                const div = document.createElement('div');
                div.className = 'worker-checkbox';
                div.innerHTML = `<input type="checkbox" id="worker_${worker.replace(/\s/g, '_')}" checked> <label for="worker_${worker.replace(/\s/g, '_')}">${worker}</label>`;
                container.appendChild(div);
            });
        }
        
        async function saveDailyEntry() {
            const date = document.getElementById('entryDate').value;
            const dayType = document.getElementById('dayType').value;
            const tonnage = parseFloat(document.getElementById('tonnage').value) || 0;
            const wagons = parseInt(document.getElementById('wagons').value) || 0;
            if (!date) { showAlert('Please select a date', 'error'); return; }
            const presentWorkers = appData.workers.filter(worker => document.getElementById(`worker_${worker.replace(/\s/g, '_')}`).checked);
            const earnings = calculateDayEarnings(date, dayType, tonnage, wagons, presentWorkers);
            if (!appData.salaries) { appData.salaries = {}; } 
            appData.salaries[date] = { date, type: dayType, tonnage, wagons, presentWorkers, earnings };
            await saveUserData();
            populateHistorySelector();
            updateHistoryDisplay();
            showAlert('Daily entry saved successfully!', 'success');
        }

        function calculateDayEarnings(entryDate, dayType, tonnage, wagons, presentWorkers) {
            const earnings = {};
            const rates = appData.agreements.current;
            const allWorkers = appData.workers;
            const absentWorkers = allWorkers.filter(w => !presentWorkers.includes(w));
            let penaltyPerPresentWorker = 0;
            const penaltyTriggeringAbsentees = [];

            if (appData.configs.isPenaltyEnabled && absentWorkers.length > 0) {
                const [fiscalYearStart, fiscalYearEnd] = getCurrentFiscalYearDates();
                absentWorkers.forEach(worker => {
                    const totalLeaves = getWorkerTotalLeaves(worker, fiscalYearStart, fiscalYearEnd);
                    if (totalLeaves > 32) {
                        penaltyTriggeringAbsentees.push(worker);
                    }
                });

                if (penaltyTriggeringAbsentees.length > 0) {
                    const basePenalty = appData.configs.penaltyAmount;
                    const multiplier = (dayType === 'special_overtime') ? 2 : 1;
                    const totalPenalty = penaltyTriggeringAbsentees.length * basePenalty * multiplier;
                    if (presentWorkers.length > 0) {
                        penaltyPerPresentWorker = totalPenalty / presentWorkers.length;
                    }
                }
            }

            let grossEarningPerWorker = 0;
            if (presentWorkers.length > 0) {
                const tonnagePay = (tonnage * rates.tonRate) / presentWorkers.length;
                const wagonPay = appData.configs.isWagonRateEnabled ? (wagons * rates.wagonRate) / presentWorkers.length : 0;
                grossEarningPerWorker = tonnagePay + wagonPay;
            }

            allWorkers.forEach(worker => {
                if (presentWorkers.includes(worker)) {
                    let adjustedEarning = grossEarningPerWorker - penaltyPerPresentWorker;
                    let minGuarantee = rates.layoffRate;
                    if (dayType === 'special_overtime') {
                        const tonnagePay = (tonnage * rates.tonRate) / presentWorkers.length;
                        const wagonPay = appData.configs.isWagonRateEnabled ? (wagons * rates.wagonRate) / presentWorkers.length : 0;
                        const overtimeGross = (tonnagePay * 2) + rates.layoffRate + wagonPay;
                        adjustedEarning = overtimeGross - penaltyPerPresentWorker;
                        minGuarantee = rates.layoffRate * 3;
                    } else if (dayType === 'rest') {
                        adjustedEarning = rates.restRate;
                        minGuarantee = rates.restRate;
                    }
                    earnings[worker] = Math.max(adjustedEarning, minGuarantee);
                } else {
                    if (penaltyTriggeringAbsentees.includes(worker)) {
                        earnings[worker] = 0;
                    } else {
                        earnings[worker] = rates.layoffRate;
                    }
                }
            });
             if (dayType === 'rest') {
                allWorkers.forEach(w => earnings[w] = rates.restRate);
            }
            return earnings;
        }

        function getCurrentFiscalYearDates() {
            const today = new Date();
            const [fiscalMonth, fiscalDay] = appData.configs.fiscalYearStart.split('-').map(Number);
            let fiscalYearStartYear = today.getFullYear();
            const fiscalStartDateForCurrentYear = new Date(fiscalYearStartYear, fiscalMonth - 1, fiscalDay);
            if (today < fiscalStartDateForCurrentYear) {
                fiscalYearStartYear--;
            }
            const fiscalYearStartDate = new Date(fiscalYearStartYear, fiscalMonth - 1, fiscalDay);
            const fiscalYearEndDate = new Date(fiscalYearStartYear + 1, fiscalMonth - 1, fiscalDay - 1);
            return [fiscalYearStartDate, fiscalYearEndDate];
        }

        function getWorkerTotalLeaves(workerName, fiscalYearStartDate, fiscalYearEndDate) {
            let leaveCount = 0;
            Object.values(appData.salaries || {}).forEach(entry => {
                const entryDate = new Date(entry.date + "T00:00:00");
                if (entryDate >= fiscalYearStartDate && entryDate <= fiscalYearEndDate) {
                    if (entry.type === 'rest' || !entry.presentWorkers.includes(workerName)) {
                        leaveCount++;
                    }
                }
            });
            return leaveCount;
        }

        function populateHistorySelector() {
            const selector = document.getElementById('historyPeriodSelector');
            const currentValue = selector.value;
            selector.innerHTML = '';
            if (!appData.configs || !appData.configs.agreementStartDate) return;
            const agreementStart = new Date(appData.configs.agreementStartDate + "T00:00:00");
            let loopDate = new Date(agreementStart.getFullYear(), agreementStart.getMonth(), 1);
            const today = new Date();
            let defaultValue = currentValue;
            if (!defaultValue) {
                const currentDay = today.getDate();
                const currentYear = today.getFullYear();
                const currentMonth = (today.getMonth() + 1).toString().padStart(2,'0');
                const currentLastDay = new Date(currentYear, today.getMonth() + 1, 0).getDate();
                defaultValue = currentDay <= 15 ? `${currentYear}-${currentMonth}-01,${currentYear}-${currentMonth}-15` : `${currentYear}-${currentMonth}-16,${currentYear}-${currentMonth}-${currentLastDay}`;
            }
            let optionsHtml = '';
            while (loopDate <= today) {
                const year = loopDate.getFullYear();
                const month = (loopDate.getMonth() + 1).toString().padStart(2, '0');
                const monthName = loopDate.toLocaleString('default', { month: 'long' });
                const lastDay = new Date(year, loopDate.getMonth() + 1, 0).getDate();
                const value2 = `${year}-${month}-16,${year}-${month}-${lastDay}`;
                const text2 = `${monthName} ${year} (16 - ${lastDay})`;
                optionsHtml = `<option value="${value2}">${text2}</option>` + optionsHtml;
                const value1 = `${year}-${month}-01,${year}-${month}-15`;
                const text1 = `${monthName} ${year} (1 - 15)`;
                optionsHtml = `<option value="${value1}">${text1}</option>` + optionsHtml;
                loopDate.setMonth(loopDate.getMonth() + 1);
            }
            selector.innerHTML = optionsHtml;
            selector.value = defaultValue;
        }

        function updateHistoryDisplay() {
            const selector = document.getElementById('historyPeriodSelector');
            if (!selector.value) {
                document.getElementById('entryResults').innerHTML = '';
                return;
            }
            const [startDateStr, endDateStr] = selector.value.split(',');
            const startDate = new Date(startDateStr + "T00:00:00");
            const endDate = new Date(endDateStr + "T00:00:00");
            const title = selector.options[selector.selectedIndex].text;
            const allEntries = Object.values(appData.salaries || {});
            const periodEntries = allEntries.filter(entry => {
                const entryDate = new Date(entry.date + "T00:00:00");
                return entryDate >= startDate && entryDate <= endDate;
            }).sort((a,b) => new Date(b.date) - new Date(a.date));
            document.getElementById('entryResults').innerHTML = generateHistoryTable(periodEntries, `History for: ${title}`);
        }

        function generateHistoryTable(entries, title) {
            let tableHtml = `<div class="history-table-container"><h3>${title}</h3>`;
            if (entries.length === 0) {
                tableHtml += `<p class="no-history">No entries for this period.</p></div>`;
                return tableHtml;
            }
            tableHtml += `<div class="history-table-wrapper"><table class="history-table"><thead><tr><th>Date</th><th>Tonnage</th><th>Workers</th><th>Pay/Worker</th></tr></thead><tbody>`;
            entries.forEach(entry => {
                let singlePay = 0;
                if (entry.presentWorkers && entry.presentWorkers.length > 0) {
                    const firstWorker = entry.presentWorkers[0];
                    singlePay = entry.earnings[firstWorker] || 0;
                } else if (entry.type === 'rest') {
                    singlePay = appData.agreements.current.restRate;
                } else if(appData.workers && appData.workers.length > 0) {
                    const anyWorker = appData.workers[0];
                    singlePay = entry.earnings[anyWorker] || 0;
                }
                tableHtml += `<tr>
                                <td>${entry.date}</td>
                                <td>${entry.tonnage > 0 ? entry.tonnage.toFixed(2) : '-'}</td>
                                <td>${entry.presentWorkers ? entry.presentWorkers.length : 0} / ${appData.workers ? appData.workers.length : 0}</td>
                                <td>${singlePay.toFixed(2)}</td>
                              </tr>`;
            });
            tableHtml += `</tbody></table></div></div>`;
            return tableHtml;
        }

        function loadAgreements() {
            Object.keys(appData.agreements.current).forEach(key => { if(document.getElementById(`current${key.charAt(0).toUpperCase() + key.slice(1)}`)) document.getElementById(`current${key.charAt(0).toUpperCase() + key.slice(1)}`).value = appData.agreements.current[key]; });
            Object.keys(appData.agreements.new).forEach(key => { if(document.getElementById(`new${key.charAt(0).toUpperCase() + key.slice(1)}`)) document.getElementById(`new${key.charAt(0).toUpperCase() + key.slice(1)}`).value = appData.agreements.new[key]; });
        }
        
        async function saveAgreements() {
            Object.keys(appData.agreements.current).forEach(key => { if(document.getElementById(`current${key.charAt(0).toUpperCase() + key.slice(1)}`)) appData.agreements.current[key] = parseFloat(document.getElementById(`current${key.charAt(0).toUpperCase() + key.slice(1)}`).value) || 0; });
            Object.keys(appData.agreements.new).forEach(key => { if(document.getElementById(`new${key.charAt(0).toUpperCase() + key.slice(1)}`)) appData.agreements.new[key] = parseFloat(document.getElementById(`new${key.charAt(0).toUpperCase() + key.slice(1)}`).value) || 0; });
            await saveUserData();
            showAlert('Agreements saved successfully!', 'success');
        }

        function loadPayPeriods() {
            const select = document.getElementById('payPeriod');
            select.innerHTML = '<option value="">Select Period</option>';
            const today = new Date();
            for (let i = 0; i < 12; i++) {
                const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const year = d.getFullYear();
                const month = (d.getMonth() + 1).toString().padStart(2,'0');
                const lastDay = new Date(year, d.getMonth() + 1, 0).getDate();
                select.innerHTML += `<option value="${year}-${month}-01,${year}-${month}-15">${d.toLocaleString('default',{month:'long'})} ${year} (1-15)</option>`;
                select.innerHTML += `<option value="${year}-${month}-16,${year}-${month}-${lastDay}">${d.toLocaleString('default',{month:'long'})} ${year} (16-End)</option>`;
            }
        }
        function generateSalaryReport() {
            const period = document.getElementById('payPeriod').value;
            if (!period) { showAlert('Please select a pay period', 'error'); return; }
            const [start, end] = period.split(',');
            const salaryData = calculatePeriodSalary(start, end);
            displaySalaryReport(salaryData, start, end);
        }
        function calculatePeriodSalary(startDate, endDate) {
            const salaries = {};
            appData.workers.forEach(w => salaries[w] = 0);
            Object.keys(appData.salaries || {}).filter(d => d >= startDate && d <= endDate).forEach(d => {
                if(appData.salaries[d].earnings) {
                    Object.keys(appData.salaries[d].earnings).forEach(w => {
                        if(salaries[w] !== undefined) salaries[w] += appData.salaries[d].earnings[w];
                    });
                }
            });
            appData.workers.forEach(w => { if(salaries[w] !== undefined) salaries[w] += appData.agreements.current.allowance / 2; });
            return salaries;
        }
        
        function displaySalaryReport(salaryData, startDate, endDate) {
            const container = document.getElementById('salaryResults');
            const viewableWorkers = appData.permissions?.viewableWorkers || [];
            let total = 0;
            let html = `<h3>Salary Report: ${startDate} to ${endDate}</h3><div class="report-grid">`;
            
            appData.workers.forEach(worker => {
                if (viewableWorkers.includes(worker)) {
                    const amount = salaryData[worker] || 0;
                    total += amount;
                    html += `<div class="report-card"><strong>${worker}</strong><br>Rs. ${amount.toFixed(2)}</div>`;
                } else {
                    html += `<div class="report-card" style="background: #f1f1f1; border-left-color: #a0a0a0;">
                                <strong>${worker}</strong><br>
                                <span style="color: #6200EE; font-weight: 500;">Contact admin to view details</span>
                             </div>`;
                }
            });

            html += `</div><div class="report-card" style="background: #e6fffa; border-left-color: #38a169;"><strong>Total Visible Salary: Rs. ${total.toFixed(2)}</strong></div>`;
            container.innerHTML = html;
        }

        function loadFiscalYears() {
            const bonusSelect = document.getElementById('fiscalYear');
            const leavesSelect = document.getElementById('leavesFiscalYear');
            if (!appData.configs) return;
            if (bonusSelect) bonusSelect.innerHTML = '<option value="">Select Year</option>';
            if (leavesSelect) leavesSelect.innerHTML = '<option value="">Select Year</option>';
            const currentYear = new Date().getFullYear();
            const fiscalStart = appData.configs.fiscalYearStart.split('-');
            const fiscalMonth = parseInt(fiscalStart[0]);
            const fiscalDay = parseInt(fiscalStart[1]);
            
            let defaultBonusValue = '';
            
            for (let i = 0; i < 3; i++) {
                const yearStart = currentYear - i;
                const yearEnd = yearStart + 1;
                const fiscalYearLabel = `${yearStart}-${yearEnd}`;
                const fiscalYearValue = `${yearStart}-${fiscalMonth.toString().padStart(2, '0')}-${fiscalDay.toString().padStart(2, '0')}`;
                
                if (i === 0) {
                    defaultBonusValue = fiscalYearValue;
                }
                
                if (bonusSelect) bonusSelect.innerHTML += `<option value="${fiscalYearValue}">${fiscalYearLabel}</option>`;
                if (leavesSelect) leavesSelect.innerHTML += `<option value="${fiscalYearValue}">${fiscalYearLabel}</option>`;
            }
            
            if (bonusSelect) {
                bonusSelect.value = defaultBonusValue;
            }
        }
        function calculateBonus() {
            const fiscalYearStart = document.getElementById('fiscalYear').value;
            if (!fiscalYearStart) { showAlert('Please select a fiscal year', 'error'); return; }
            const bonusData = calculateAnnualBonus(fiscalYearStart);
            displayBonusReport(bonusData, fiscalYearStart);
        }
        function calculateAnnualBonus(fiscalYearStart) {
            const startDate = new Date(fiscalYearStart);
            const endDate = new Date(startDate);
            endDate.setFullYear(endDate.getFullYear() + 1);
            endDate.setDate(endDate.getDate() - 1);
            const workerBonuses = {};
            appData.workers.forEach(worker => {
                let annualEarnings = 0, workDays = 0, restDays = 0;
                Object.entries(appData.salaries || {}).forEach(([date, entry]) => {
                    const entryDate = new Date(date);
                    if (entryDate >= startDate && entryDate <= endDate) {
                        if (entry.earnings[worker] !== undefined) {
                            annualEarnings += entry.earnings[worker];
                            if (entry.type === 'rest') { restDays++; } else { workDays++; }
                        }
                    }
                });
                annualEarnings += appData.agreements.current.allowance * 12;
                const avgMonthlySalary = annualEarnings / 12;
                const bonus = avgMonthlySalary;
                const gratuity = avgMonthlySalary;
                const totalLeaves = restDays;
                const unpaidLeaves = Math.min(totalLeaves, 20);
                const paidLeaves = Math.min(Math.max(totalLeaves - 20, 0), 12);
                const remainingPaidLeaves = 12 - paidLeaves;
                const paidLeavesBonus = remainingPaidLeaves * appData.agreements.current.layoffRate;
                const totalBonus = bonus + gratuity + paidLeavesBonus;
                workerBonuses[worker] = { annualEarnings, avgMonthlySalary, bonus, gratuity, totalLeaves, unpaidLeaves, paidLeaves, remainingPaidLeaves, paidLeavesBonus, totalBonus };
            });
            return workerBonuses;
        }

        function displayBonusReport(bonusData, fiscalYearStart) {
            const container = document.getElementById('bonusResults');
            const viewableWorkers = appData.permissions?.viewableWorkers || [];
            const startYear = new Date(fiscalYearStart).getFullYear();
            let html = `<h3>Annual Bonus Report: ${startYear}-${startYear + 1}</h3><div class="report-grid">`;
            
            appData.workers.forEach(worker => {
                if (viewableWorkers.includes(worker)) {
                    const data = bonusData[worker] || {};
                    html += `<div class="report-card"><strong>${worker}</strong><br>Annual Earnings: Rs. ${(data.annualEarnings || 0).toFixed(2)}<br>Avg Monthly: Rs. ${(data.avgMonthlySalary || 0).toFixed(2)}<br>Bonus: Rs. ${(data.bonus || 0).toFixed(2)}<br>Gratuity: Rs. ${(data.gratuity || 0).toFixed(2)}<br>Paid Leaves Bonus: Rs. ${(data.paidLeavesBonus || 0).toFixed(2)}<br><strong>Total Bonus: Rs. ${(data.totalBonus || 0).toFixed(2)}</strong></div>`;
                } else {
                    html += `<div class="report-card" style="background: #f1f1f1; border-left-color: #a0a0a0;">
                                <strong>${worker}</strong><br>
                                <span style="color: #6200EE; font-weight: 500;">Contact admin to view details</span>
                             </div>`;
                }
            });

            html += `</div>`;
            container.innerHTML = html;
        }

        function calculateArrears() {
            const container = document.getElementById('arrearsResults');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Calculating arrears...</p></div>';
            setTimeout(() => {
                const arrearsData = calculateAllArrears();
                displayArrearsReport(arrearsData);
            }, 500);
        }
        function calculateAllArrears() {
            const agreementStartDate = new Date(appData.configs.agreementStartDate);
            const currentDate = new Date();
            const workerArrears = {};
            const fiscalYearStart = document.getElementById('fiscalYear').value || `${new Date().getFullYear()}-10-10`;
            appData.workers.forEach(worker => {
                let salaryArrears = 0, allowanceArrears = 0, bonusArrears = 0;
                const annualBenefitsArrears = appData.agreements.new.annualBenefits - appData.agreements.current.annualBenefits;
                Object.entries(appData.salaries || {}).forEach(([date, entry]) => {
                    const entryDate = new Date(date);
                    if (entryDate >= agreementStartDate && entryDate <= currentDate) {
                        if (entry.earnings && entry.earnings[worker] !== undefined) {
                            const newEarnings = calculateDayEarningsWithRates(entry.type, entry.tonnage, entry.wagons, entry.presentWorkers, appData.agreements.new);
                            const currentEarning = entry.earnings[worker];
                            const newEarning = newEarnings[worker] || 0;
                            salaryArrears += (newEarning - currentEarning);
                        }
                    }
                });
                let allowanceMonths = 0;
                const startMonth = agreementStartDate.getMonth();
                const startYear = agreementStartDate.getFullYear();
                const endMonth = currentDate.getMonth();
                const endYear = currentDate.getFullYear();
                allowanceMonths = (endYear - startYear) * 12 + (endMonth - startMonth) + 1;
                allowanceArrears = allowanceMonths * (appData.agreements.new.allowance - appData.agreements.current.allowance);
                const newBonus = calculateAnnualBonusWithRates(appData.agreements.new, fiscalYearStart);
                const currentBonus = calculateAnnualBonusWithRates(appData.agreements.current, fiscalYearStart);
                bonusArrears = (newBonus[worker]?.totalBonus || 0) - (currentBonus[worker]?.totalBonus || 0);
                const totalArrears = salaryArrears + allowanceArrears + bonusArrears + annualBenefitsArrears;
                workerArrears[worker] = { salaryArrears, allowanceArrears, bonusArrears, annualBenefitsArrears, totalArrears };
            });
            return workerArrears;
        }
        function calculateDayEarningsWithRates(dayType, tonnage, wagons, presentWorkers, rates) {
            const earnings = {};
            const allWorkers = appData.workers || [];
            if (dayType === 'rest') { allWorkers.forEach(worker => { earnings[worker] = rates.restRate; }); }
            else {
                const presentCount = presentWorkers.length;
                if (presentCount > 0) {
                    let grossPay = (tonnage * rates.tonRate) / presentCount + (wagons * rates.wagonRate) / presentCount;
                    if (dayType === 'special_overtime') { grossPay = ((tonnage * rates.tonRate) / presentCount * 2) + rates.layoffRate + (wagons * rates.wagonRate) / presentCount; }
                    grossPay = Math.max(grossPay, dayType === 'special_overtime' ? rates.layoffRate * 3 : rates.layoffRate);
                    presentWorkers.forEach(worker => { earnings[worker] = grossPay; });
                }
                allWorkers.forEach(worker => { if (!presentWorkers.includes(worker)) { earnings[worker] = rates.layoffRate; } });
            }
            return earnings;
        }
        function calculateAnnualBonusWithRates(rates, fiscalYearStart) {
            const startDate = new Date(fiscalYearStart);
            const endDate = new Date(startDate);
            endDate.setFullYear(endDate.getFullYear() + 1);
            const workerBonuses = {};
            appData.workers.forEach(worker => {
                let annualEarnings = 0, totalLeaves = 0;
                Object.entries(appData.salaries || {}).forEach(([date, entry]) => {
                    const entryDate = new Date(date);
                    if (entryDate >= startDate && entryDate < endDate) {
                        if (entry.earnings && entry.earnings[worker] !== undefined) {
                            annualEarnings += calculateDayEarningsWithRates(entry.type, entry.tonnage, entry.wagons, entry.presentWorkers, rates)[worker];
                             if (entry.type === 'rest' || !entry.presentWorkers.includes(worker)) {
                                totalLeaves++;
                            }
                        }
                    }
                });
                annualEarnings += rates.allowance * 12;
                const avgMonthlySalary = annualEarnings / 12;
                const paidLeaves = Math.min(Math.max(totalLeaves - 20, 0), 12);
                const remainingPaidLeaves = 12 - paidLeaves;
                workerBonuses[worker] = {
                    totalBonus: avgMonthlySalary * 2 + (remainingPaidLeaves * rates.layoffRate)
                };
            });
            return workerBonuses;
        }
        
        function displayArrearsReport(arrearsData) {
            const container = document.getElementById('arrearsResults');
            const viewableWorkers = appData.permissions?.viewableWorkers || [];
            let html = `<h3>Arrears Calculation Report</h3><p>From Agreement Start Date: ${appData.configs.agreementStartDate}</p><div class="report-grid">`;

            appData.workers.forEach(worker => {
                if (viewableWorkers.includes(worker)) {
                    const data = arrearsData[worker] || {};
                    html += `<div class="report-card"><strong>${worker}</strong><br>Salary Arrears: Rs. ${(data.salaryArrears || 0).toFixed(2)}<br>Allowance Arrears: Rs. ${(data.allowanceArrears || 0).toFixed(2)}<br>Bonus Arrears: Rs. ${(data.bonusArrears || 0).toFixed(2)}<br>Annual Benefits Arrears: Rs. ${(data.annualBenefitsArrears || 0).toFixed(2)}<br><strong>Total Arrears: Rs. ${(data.totalArrears || 0).toFixed(2)}</strong></div>`;
                } else {
                    html += `<div class="report-card" style="background: #f1f1f1; border-left-color: #a0a0a0;">
                                <strong>${worker}</strong><br>
                                <span style="color: #6200EE; font-weight: 500;">Contact admin to view details</span>
                             </div>`;
                }
            });

            html += `</div>`;
            container.innerHTML = html;
        }

        function generateLeavesReport() {
            const fiscalYearStart = document.getElementById('leavesFiscalYear').value;
            if (!fiscalYearStart) { showAlert('Please select a fiscal year', 'error'); return; }
            const leavesData = calculateLeavesReport(fiscalYearStart);
            displayLeavesReport(leavesData, fiscalYearStart);
        }
        function calculateLeavesReport(fiscalYearStart) {
            const startDate = new Date(fiscalYearStart);
            const endDate = new Date(startDate);
            endDate.setFullYear(endDate.getFullYear() + 1);
            endDate.setDate(endDate.getDate() - 1);
            const workerLeaves = {};
            appData.workers.forEach(worker => {
                let totalLeaves = 0, workDays = 0;
                Object.entries(appData.salaries || {}).forEach(([date, entry]) => {
                    const entryDate = new Date(date);
                    if (entryDate >= startDate && entryDate <= endDate) {
                        if (entry.type === 'rest' || !entry.presentWorkers.includes(worker)) {
                            totalLeaves++;
                        } else {
                            workDays++;
                        }
                    }
                });
                const unpaidLeaves = Math.min(totalLeaves, 20);
                const paidLeaves = Math.min(Math.max(totalLeaves - 20, 0), 12);
                const excessLeaves = Math.max(totalLeaves - 32, 0);
                const remainingPaidLeaves = 12 - paidLeaves;
                workerLeaves[worker] = { totalLeaves, unpaidLeaves, paidLeaves, excessLeaves, remainingPaidLeaves, workDays };
            });
            return workerLeaves;
        }

        function displayLeavesReport(leavesData, fiscalYearStart) {
            const container = document.getElementById('leavesResults');
            const viewableWorkers = appData.permissions?.viewableWorkers || [];
            const startYear = new Date(fiscalYearStart).getFullYear();
            let html = `<h3>Leaves Report: ${startYear}-${startYear + 1}</h3><div class="alert alert-info show"><strong>Leave Structure:</strong> 20 Unpaid Leaves + 12 Paid Leaves = 32 Total Annual Leaves</div><div class="report-grid">`;
            
            appData.workers.forEach(worker => {
                if (viewableWorkers.includes(worker)) {
                    const data = leavesData[worker] || {};
                    html += `<div class="report-card"><strong>${worker}</strong><br>Work Days: ${data.workDays || 0}<br>Total Leaves: ${data.totalLeaves || 0}<br>Unpaid Leaves: ${data.unpaidLeaves || 0}/20<br>Paid Leaves Used: ${data.paidLeaves || 0}/12<br>Remaining Paid: ${data.remainingPaidLeaves || 0}<br>${(data.excessLeaves || 0) > 0 ? `<span style="color: #e53e3e;">Excess Leaves: ${data.excessLeaves}</span>` : ''}</div>`;
                } else {
                    html += `<div class="report-card" style="background: #f1f1f1; border-left-color: #a0a0a0;">
                                <strong>${worker}</strong><br>
                                <span style="color: #6200EE; font-weight: 500;">Contact admin to view details</span>
                             </div>`;
                }
            });

            html += '</div>';
            container.innerHTML = html;
        }
        function loadSettings() {
            if (!appData.configs) return;
            document.getElementById('workerCount').value = appData.configs.workerCount;
            document.getElementById('agreementStartDate').value = appData.configs.agreementStartDate;
            document.getElementById('fiscalYearStart').value = appData.configs.fiscalYearStart;
            document.getElementById('enableWagonRate').checked = appData.configs.isWagonRateEnabled;
            document.getElementById('enablePenalty').checked = appData.configs.isPenaltyEnabled;
            document.getElementById('penaltyAmount').value = appData.configs.penaltyAmount;
            document.getElementById('penaltyAmountContainer').style.display = appData.configs.isPenaltyEnabled ? 'block' : 'none';
            toggleWagonUIElements(appData.configs.isWagonRateEnabled);
            
            if (appData.configs.isSetupComplete) {
                document.getElementById('manageWorkersSection').style.display = 'none';
            } else {
                 document.getElementById('manageWorkersSection').style.display = 'block';
                 loadWorkersList();
            }
        }
        function loadWorkersList() {
            const container = document.getElementById('workersList');
            container.innerHTML = '';
            (appData.workers || []).forEach((worker, index) => {
                const div = document.createElement('div');
                div.className = 'form-group';
                div.innerHTML = `<label>Worker ${index + 1}:</label><input type="text" value="${worker}" disabled>`;
                container.appendChild(div);
            });
        }
        
        async function addWorker() { showAlert('Cannot add workers after initial setup.', 'error'); }
        async function removeWorker(index) { showAlert('Cannot remove workers after initial setup.', 'error'); }
        async function updateWorkerName(index, newName) { showAlert('Cannot change worker names after initial setup.', 'error'); }
        
        async function saveSettings() {
            appData.configs.agreementStartDate = document.getElementById('agreementStartDate').value;
            appData.configs.fiscalYearStart = document.getElementById('fiscalYearStart').value;
            appData.configs.isWagonRateEnabled = document.getElementById('enableWagonRate').checked;
            appData.configs.isPenaltyEnabled = document.getElementById('enablePenalty').checked;
            appData.configs.penaltyAmount = parseFloat(document.getElementById('penaltyAmount').value) || 231;
            await saveUserData();
            showAlert('Settings saved successfully!', 'success');
        }

        function showAlert(message, type = 'info') {
            const existingAlert = document.getElementById('custom-alert');
            if (existingAlert) {
                existingAlert.remove();
            }

            const alertDiv = document.createElement('div');
            alertDiv.id = 'custom-alert';
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            document.body.appendChild(alertDiv);

            setTimeout(() => {
                alertDiv.classList.add('show');
            }, 10);

            setTimeout(() => {
                alertDiv.classList.remove('show');
                alertDiv.addEventListener('transitionend', () => {
                    if(alertDiv) alertDiv.remove();
                });
            }, 5000);
        }
    </script>
</body>
</html>
