<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Existing head content remains unchanged -->
    <style>
        /* Add these new styles at the end of existing styles */
        
        /* Setup Wizard Styles */
        .wizard-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.7);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .wizard-container {
            background-color: var(--surface-color);
            border-radius: 8px;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            overflow: hidden;
            animation: wizardFadeIn 0.3s ease;
        }
        
        @keyframes wizardFadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .wizard-header {
            background-color: var(--primary-color);
            color: var(--on-primary-color);
            padding: 16px;
            position: relative;
        }
        
        .wizard-title {
            font-size: 18px;
            font-weight: 500;
            margin: 0;
            display: flex;
            align-items: center;
        }
        
        .wizard-title .material-icons {
            margin-right: 8px;
        }
        
        .wizard-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .wizard-step {
            display: none;
        }
        
        .wizard-step.active {
            display: block;
        }
        
        .wizard-footer {
            display: flex;
            justify-content: space-between;
            padding: 16px;
            border-top: 1px solid #eee;
        }
        
        .wizard-navigation-btn {
            min-width: 100px;
        }
        
        .wizard-progress {
            height: 4px;
            background-color: #e0e0e0;
            margin-top: 8px;
        }
        
        .wizard-progress-bar {
            height: 100%;
            background-color: var(--secondary-color);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .wizard-warning {
            background-color: #FFF3E0;
            border-left: 4px solid #FFA000;
            padding: 12px;
            margin: 12px 0;
            font-size: 14px;
            display: flex;
            align-items: flex-start;
        }
        
        .wizard-warning .material-icons {
            color: #FFA000;
            margin-right: 8px;
            font-size: 20px;
        }
        
        /* Bottom Notifications */
        .alert {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            max-width: 90%;
            width: 400px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: alertSlideUp 0.3s ease;
        }
        
        @keyframes alertSlideUp {
            from { bottom: -100px; opacity: 0; }
            to { bottom: 20px; opacity: 1; }
        }
        
        /* Settings Lock Styles */
        .settings-lock {
            background-color: #FFF8E1;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #FFC107;
        }
        
        .settings-lock-btn {
            margin-top: 10px;
        }
        
        /* Responsive Adjustments */
        @media (max-width: 600px) {
            .wizard-container {
                max-width: 100%;
                margin: 0 10px;
            }
            
            .wizard-body {
                padding: 15px;
            }
            
            .wizard-navigation-btn {
                min-width: 80px;
                padding: 8px 12px;
            }
        }
        
        /* Worker Input Styles */
        .worker-input-container {
            margin-bottom: 15px;
        }
        
        .worker-input-container input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <!-- Existing header, nav, overlay remain unchanged -->
    
    <!-- Setup Wizard -->
    <div id="setupWizard" class="wizard-overlay">
        <div class="wizard-container">
            <div class="wizard-header">
                <h2 class="wizard-title"><i class="material-icons">settings</i> Initial Setup</h2>
                <div class="wizard-progress">
                    <div class="wizard-progress-bar" id="wizardProgress"></div>
                </div>
            </div>
            
            <div class="wizard-body">
                <!-- Step 1: Team Size -->
                <div class="wizard-step active" id="step1">
                    <h3>Team Information</h3>
                    <p>Let's start by setting up your team structure.</p>
                    
                    <div class="form-group">
                        <label>How many workers are in your team?</label>
                        <input type="number" id="teamSize" min="1" max="20" value="8" class="form-control">
                    </div>
                    
                    <div class="wizard-warning">
                        <i class="material-icons">warning</i>
                        <div>This setting cannot be changed later without resetting your data. Please enter carefully.</div>
                    </div>
                </div>
                
                <!-- Step 2: Worker Names -->
                <div class="wizard-step" id="step2">
                    <h3>Worker Details</h3>
                    <p>Enter names for each worker in your team.</p>
                    
                    <div id="workerNameInputs"></div>
                    
                    <div class="wizard-warning">
                        <i class="material-icons">warning</i>
                        <div>Worker names will be locked after setup. You'll need to unlock them in settings to make changes.</div>
                    </div>
                </div>
                
                <!-- Step 3: Agreement Details -->
                <div class="wizard-step" id="step3">
                    <h3>Current Agreement Rates</h3>
                    <p>Enter your current agreement rates with workers.</p>
                    
                    <div class="form-group">
                        <label>Ton Rate (Rs):</label>
                        <input type="number" id="wizardTonRate" value="22">
                    </div>
                    <div class="form-group">
                        <label>Rest Rate (Rs):</label>
                        <input type="number" id="wizardRestRate" value="1100">
                    </div>
                    <div class="form-group">
                        <label>Layoff Rate (Rs):</label>
                        <input type="number" id="wizardLayoffRate" value="549">
                    </div>
                    <div class="form-group">
                        <label>Monthly Allowance (Rs):</label>
                        <input type="number" id="wizardAllowance" value="20000">
                    </div>
                    
                    <div class="wizard-warning">
                        <i class="material-icons">warning</i>
                        <div>These rates will be used for all calculations. You can update them later in Agreements section.</div>
                    </div>
                </div>
                
                <!-- Step 4: Agreement Date -->
                <div class="wizard-step" id="step4">
                    <h3>Agreement Start Date</h3>
                    <p>When did this agreement start?</p>
                    
                    <div class="form-group">
                        <label>Agreement Start Date:</label>
                        <input type="date" id="wizardAgreementDate">
                    </div>
                    
                    <div class="form-group">
                        <label>Fiscal Year Start (MM-DD):</label>
                        <input type="text" id="wizardFiscalYearStart" placeholder="10-10" pattern="[0-9]{2}-[0-9]{2}">
                    </div>
                    
                    <div class="wizard-warning">
                        <i class="material-icons">warning</i>
                        <div>This date will affect all historical calculations. Please enter carefully.</div>
                    </div>
                </div>
            </div>
            
            <div class="wizard-footer">
                <button class="btn" id="wizardBackBtn" disabled><i class="material-icons">chevron_left</i> Back</button>
                <button class="btn" id="wizardNextBtn">Next <i class="material-icons">chevron_right</i></button>
            </div>
        </div>
    </div>

    <!-- Existing main content remains unchanged -->
    
    <!-- Modified Settings Section -->
    <div id="settings" class="page">
        <h2>⚙️ Settings</h2>
        <p>Configure your application settings</p>
        
        <h3>General Settings</h3>
        <div class="form-group"><label>Number of Workers:</label><input type="number" id="workerCount" placeholder="8" disabled></div>
        <div class="form-group"><label>Agreement Start Date:</label><input type="date" id="agreementStartDate" disabled></div>
        <div class="form-group"><label>Fiscal Year Start (MM-DD):</label><input type="text" id="fiscalYearStart" placeholder="10-10" pattern="[0-9]{2}-[0-9]{2}" disabled></div>
        
        <div class="settings-section">
            <h3>Feature Controls</h3>
            <div class="checkbox-group">
                <input type="checkbox" id="enableWagonRate">
                <label for="enableWagonRate">Enable Wagon Rate Calculation</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="enablePenalty">
                <label for="enablePenalty">Enable Excess Leave Penalty</label>
            </div>
            <div class="sub-setting" id="penaltyAmountContainer" style="display: none;">
                <div class="form-group">
                    <label for="penaltyAmount">Penalty Amount (Normal Day)</label>
                    <input type="number" id="penaltyAmount">
                </div>
            </div>
        </div>

        <div class="settings-section" id="workerSettingsSection">
            <div class="settings-lock" id="workerSettingsLock">
                <h3><i class="material-icons">lock</i> Worker Settings Locked</h3>
                <p>Changing worker names may affect your historical data. Unlock carefully.</p>
                <button onclick="unlockWorkerSettings()" class="btn btn-danger settings-lock-btn">
                    <i class="material-icons">lock_open</i> Unlock Worker Settings
                </button>
            </div>
            
            <h3>Manage Workers</h3>
            <div id="workersList"></div>
            <button onclick="addWorker()" class="btn btn-success" id="addWorkerBtn" style="display: none;">Add Worker</button>
        </div>
        <button onclick="saveSettings()" class="btn">Save Settings</button>
    </div>

    <script>
        // Global Variables
        let currentUser = null;
        let currentWizardStep = 1;
        let workerSettingsUnlocked = false;
        let isNewUser = false;
        
        let appData = { 
            salaries: {}, 
            workers: [],
            permissions: {
                viewableWorkers: []
            },
            configs: { 
                workerCount: 8, 
                agreementStartDate: '2023-10-10', 
                fiscalYearStart: '10-10', 
                isPenaltyEnabled: false, 
                penaltyAmount: 231, 
                isWagonRateEnabled: false 
            }, 
            agreements: { 
                current: { tonRate: 22, restRate: 1100, layoffRate: 549, wagonRate: 0, allowance: 20000, annualBenefits: 0 }, 
                new: { tonRate: 25, restRate: 1200, layoffRate: 600, wagonRate: 0, allowance: 26000, annualBenefits: 0 } 
            } 
        };

        // Initialize App
        async function startApp() {
            try {
                const response = await fetch('/.netlify/functions/get-config');
                if (!response.ok) throw new Error('Configuration fetch failed');
                
                const firebaseConfig = await response.json();
                firebase.initializeApp(firebaseConfig);
                
                // Set up auth state listener
                firebase.auth().onAuthStateChanged(async (user) => {
                    if (user) {
                        currentUser = user;
                        await showMainApp();
                    } else {
                        currentUser = null;
                        showLoginPage();
                    }
                });
                
                // Setup event listeners
                setupEventListeners();
                
            } catch (error) {
                console.error("App initialization error:", error);
                showErrorScreen();
            }
        }

        // Setup Event Listeners
        function setupEventListeners() {
            // Wizard navigation
            document.getElementById('wizardNextBtn').addEventListener('click', goToNextStep);
            document.getElementById('wizardBackBtn').addEventListener('click', goToPrevStep);
            
            // Existing listeners
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', () => showPage(btn.dataset.page));
            });
            
            document.getElementById('entryDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('dayType').addEventListener('change', function() {
                document.getElementById('workDetails').style.display = this.value === 'rest' ? 'none' : 'block';
            });
            
            document.getElementById('enablePenalty').addEventListener('change', (e) => {
                document.getElementById('penaltyAmountContainer').style.display = e.target.checked ? 'block' : 'none';
            });
            
            document.getElementById('enableWagonRate').addEventListener('change', (e) => {
                toggleWagonUIElements(e.target.checked);
            });
        }

        // Show Main App
        async function showMainApp() {
            document.getElementById('login-page').classList.remove('active');
            document.getElementById('appHeader').style.display = 'flex';
            document.getElementById('userInfo').style.display = 'flex';
            document.getElementById('sideNav').style.display = 'flex';
            document.getElementById('userName').textContent = currentUser.displayName || currentUser.email;
            
            await loadUserData();
            
            if (isNewUser && (!appData.workers || appData.workers.length === 0)) {
                showSetupWizard();
            } else {
                setupUI();
                showPage('daily-entry');
            }
        }

        // Show Setup Wizard
        function showSetupWizard() {
            document.getElementById('setupWizard').style.display = 'flex';
            document.getElementById('wizardAgreementDate').value = new Date().toISOString().split('T')[0];
            updateWizardProgress();
        }

        // Hide Setup Wizard
        function hideSetupWizard() {
            document.getElementById('setupWizard').style.display = 'none';
        }

        // Wizard Navigation Functions
        function goToNextStep() {
            if (currentWizardStep === 4) {
                completeSetup();
                return;
            }
            
            if (!validateCurrentStep()) return;
            
            if (currentWizardStep === 1) {
                generateWorkerNameInputs();
            }
            
            document.getElementById(`step${currentWizardStep}`).classList.remove('active');
            currentWizardStep++;
            document.getElementById(`step${currentWizardStep}`).classList.add('active');
            updateWizardProgress();
        }

        function goToPrevStep() {
            document.getElementById(`step${currentWizardStep}`).classList.remove('active');
            currentWizardStep--;
            document.getElementById(`step${currentWizardStep}`).classList.add('active');
            updateWizardProgress();
        }

        function updateWizardProgress() {
            const progress = (currentWizardStep / 4) * 100;
            document.getElementById('wizardProgress').style.width = `${progress}%`;
            
            document.getElementById('wizardBackBtn').disabled = currentWizardStep === 1;
            document.getElementById('wizardNextBtn').innerHTML = currentWizardStep === 4 ? 
                'Finish Setup <i class="material-icons">check</i>' : 
                'Next <i class="material-icons">chevron_right</i>';
        }

        // Step Validation
        function validateCurrentStep() {
            if (currentWizardStep === 1) {
                const teamSize = parseInt(document.getElementById('teamSize').value);
                if (isNaN(teamSize) || teamSize < 1) {
                    showAlert('Please enter a valid team size (minimum 1)', 'error');
                    return false;
                }
            }
            else if (currentWizardStep === 2) {
                const inputs = document.querySelectorAll('#workerNameInputs input');
                for (let input of inputs) {
                    if (!input.value.trim()) {
                        showAlert('Please enter names for all workers', 'error');
                        return false;
                    }
                }
            }
            else if (currentWizardStep === 3) {
                const tonRate = parseFloat(document.getElementById('wizardTonRate').value);
                if (isNaN(tonRate)) {
                    showAlert('Please enter valid agreement rates', 'error');
                    return false;
                }
            }
            else if (currentWizardStep === 4) {
                const agreementDate = document.getElementById('wizardAgreementDate').value;
                if (!agreementDate) {
                    showAlert('Please select agreement start date', 'error');
                    return false;
                }
            }
            return true;
        }

        // Generate Worker Name Inputs
        function generateWorkerNameInputs() {
            const container = document.getElementById('workerNameInputs');
            const teamSize = parseInt(document.getElementById('teamSize').value);
            container.innerHTML = '';
            
            for (let i = 0; i < teamSize; i++) {
                const div = document.createElement('div');
                div.className = 'worker-input-container';
                div.innerHTML = `
                    <label>Worker ${i+1} Name:</label>
                    <input type="text" value="Worker ${i+1}" class="worker-name-input">
                `;
                container.appendChild(div);
            }
        }

        // Complete Setup
        async function completeSetup() {
            if (!validateCurrentStep()) return;
            
            const teamSize = parseInt(document.getElementById('teamSize').value);
            const workerNames = [];
            const inputs = document.querySelectorAll('#workerNameInputs input');
            inputs.forEach(input => workerNames.push(input.value.trim()));
            
            const agreementData = {
                tonRate: parseFloat(document.getElementById('wizardTonRate').value),
                restRate: parseFloat(document.getElementById('wizardRestRate').value),
                layoffRate: parseFloat(document.getElementById('wizardLayoffRate').value),
                allowance: parseFloat(document.getElementById('wizardAllowance').value),
                annualBenefits: 0,
                wagonRate: 0
            };
            
            const agreementStartDate = document.getElementById('wizardAgreementDate').value;
            const fiscalYearStart = document.getElementById('wizardFiscalYearStart').value || '10-10';
            
            // Initialize appData
            appData = { 
                salaries: {}, 
                workers: workerNames,
                permissions: {
                    viewableWorkers: workerNames.length > 0 ? [workerNames[0]] : []
                },
                configs: { 
                    workerCount: teamSize, 
                    agreementStartDate: agreementStartDate, 
                    fiscalYearStart: fiscalYearStart, 
                    isPenaltyEnabled: false, 
                    penaltyAmount: 231, 
                    isWagonRateEnabled: false 
                }, 
                agreements: { 
                    current: agreementData, 
                    new: JSON.parse(JSON.stringify(agreementData))
                } 
            };
            
            await saveUserData();
            hideSetupWizard();
            setupUI();
            showPage('daily-entry');
            showAlert('Initial setup completed successfully!', 'success');
        }

        // Worker Settings Lock
        function unlockWorkerSettings() {
            const confirmed = confirm('Warning: Changing worker names may affect your historical data. Are you sure you want to unlock worker settings?');
            if (confirmed) {
                workerSettingsUnlocked = true;
                document.getElementById('workerSettingsLock').style.display = 'none';
                document.getElementById('addWorkerBtn').style.display = 'inline-block';
                loadWorkersList(true);
                showAlert('Worker settings unlocked. Changes will be saved when you click Save Settings.', 'info');
            }
        }

        // Load Workers List
        function loadWorkersList(editable = false) {
            const container = document.getElementById('workersList');
            container.innerHTML = '';
            
            if (!appData.workers || appData.workers.length === 0) {
                container.innerHTML = "<p>No workers found.</p>";
                return;
            }
            
            if (!workerSettingsUnlocked) {
                document.getElementById('workerSettingsLock').style.display = 'block';
                document.getElementById('addWorkerBtn').style.display = 'none';
            } else {
                document.getElementById('workerSettingsLock').style.display = 'none';
                document.getElementById('addWorkerBtn').style.display = 'inline-block';
            }
            
            appData.workers.forEach((worker, index) => {
                const div = document.createElement('div');
                div.className = 'form-group';
                
                if (editable) {
                    div.innerHTML = `
                        <label>Worker ${index + 1}:</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" value="${worker}" onchange="updateWorkerName(${index}, this.value)" style="flex: 1;">
                            <button onclick="removeWorker(${index})" class="btn btn-danger" style="padding: 8px 12px;">Remove</button>
                        </div>
                    `;
                } else {
                    div.innerHTML = `
                        <label>Worker ${index + 1}:</label>
                        <input type="text" value="${worker}" readonly style="background-color: #f5f5f5;">
                    `;
                }
                
                container.appendChild(div);
            });
        }

        // Initialize New User Data
        async function initializeNewUserData() {
            isNewUser = true;
            showSetupWizard();
        }

        // Rest of the existing functions remain unchanged
        // ... [all other existing functions] ...

        // Start the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', startApp);
    </script>
</body>
</html>
