<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PM's Salary Manager - Digital Munshi</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Firebase Libraries (already included) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-auth-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-database-compat.min.js"></script>
    <style>
        :root {
            --primary-color: #6200EE;
            --primary-variant-color: #3700B3;
            --secondary-color: #03DAC6;
            --background-color: #f5f5f5;
            --surface-color: #FFFFFF;
            --on-primary-color: #FFFFFF;
            --on-surface-color: #000000;
            --error-color: #B00020;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Roboto', sans-serif; background-color: var(--background-color); color: var(--on-surface-color); }
        .header { background-color: var(--primary-color); color: var(--on-primary-color); padding: 0 16px; height: 64px; display: flex; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2); position: fixed; top: 0; left: 0; right: 0; z-index: 1000; }
        .header h1 { font-size: 20px; font-weight: 500; margin-left: 16px; }
        .menu-icon { cursor: pointer; padding: 8px; border-radius: 50%; transition: background-color 0.3s; }
        .menu-icon:hover { background-color: rgba(255,255,255,0.1); }
        #userInfo { margin-left: auto; display: none; align-items: center; }
        #userName { font-size: 14px; }
        .side-nav { position: fixed; top: 0; left: -300px; width: 280px; height: 100%; background-color: var(--surface-color); box-shadow: 2px 0 5px rgba(0,0,0,0.2); z-index: 1100; transition: left 0.3s ease-in-out; display: flex; flex-direction: column; }
        .side-nav.open { left: 0; }
        .nav-header { padding: 16px; background-color: var(--primary-variant-color); color: var(--on-primary-color); }
        .nav-header h2 { font-size: 18px; font-weight: 500; }
        .nav-header p { font-size: 12px; opacity: 0.8; }
        .nav-buttons-container { list-style: none; padding-top: 8px; flex-grow: 1; overflow-y: auto; }
        .nav-btn { display: flex; align-items: center; padding: 12px 16px; cursor: pointer; transition: background-color 0.3s; border: none; background: none; width: 100%; text-align: left; font-size: 14px; color: var(--on-surface-color); }
        .nav-btn .material-icons { margin-right: 24px; color: #5f6368; }
        .nav-btn:hover { background-color: rgba(0,0,0,0.05); }
        .nav-btn.active { background-color: rgba(98, 0, 238, 0.08); color: var(--primary-color); font-weight: 500; }
        .nav-btn.active .material-icons { color: var(--primary-color); }
        #main-content { padding: 76px 16px 16px 16px; width: 100%; }
        .page { display: none; background: var(--surface-color); padding: 16px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24); }
        .page.active { display: block; }
        .page > h2 { font-size: 20px; font-weight: 500; margin-bottom: 4px; color: var(--primary-color); }
        .page > p { margin-bottom: 12px; font-size: 14px; color: rgba(0,0,0,0.6); }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 4px; font-weight: 500; font-size: 14px; color: #4a5568; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(98, 0, 238, 0.2); }
        .btn { background-color: var(--primary-color); color: var(--on-primary-color); border: none; padding: 10px 16px; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 500; text-transform: uppercase; box-shadow: 0 2px 2px 0 rgba(0,0,0,0.14), 0 3px 1px -2px rgba(0,0,0,0.12), 0 1px 5px 0 rgba(0,0,0,0.2); transition: all 0.2s; margin: 4px; outline: none; display: inline-flex; align-items: center; justify-content: center; }
        .btn:hover { background-color: var(--primary-variant-color); box-shadow: 0 3px 3px 0 rgba(0,0,0,0.14), 0 1px 7px 0 rgba(0,0,0,0.12), 0 3px 1px -1px rgba(0,0,0,0.2); }
        .btn:disabled { background-color: #e0e0e0; cursor: not-allowed; box-shadow: none; }
        .btn-danger { background-color: var(--error-color); }
        .btn-danger:hover { background-color: #9a001b; }
        .btn-success { background-color: #00C853; }
        .btn-success:hover { background-color: #00b048; }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1050; }
        .overlay.open { display: block; }
        .alert { padding: 15px; border-radius: 6px; margin: 15px 0; border: 1px solid transparent; }
        .alert-success { background: #c6f6d5; color: #22543d; border-color: #9ae6b4; }
        .alert-error { background: #fed7d7; color: #742a2a; border-color: #fc8181; }
        
        /* --- NAYA SETUP WIZARD STYLES --- */
        #setup-wizard {
            display: none; /* Initially hidden */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(245, 245, 245, 0.95);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .setup-container {
            background-color: var(--surface-color);
            padding: 32px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 700px;
            text-align: center;
        }
        .setup-container h2 {
            font-size: 24px;
            color: var(--primary-color);
            margin-bottom: 8px;
        }
        .setup-container p {
            font-size: 16px;
            margin-bottom: 24px;
            color: rgba(0,0,0,0.7);
        }
        .setup-step {
            display: none; /* Hide steps by default */
        }
        .setup-step.active {
            display: block; /* Show active step */
        }
        #setup-workers-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-top: 16px;
            text-align: left;
        }
        input[readonly].locked-input {
            background-color: #f2f2f2;
            cursor: not-allowed;
            color: #777;
        }

        /* --- NAYA POP-UP MODAL STYLES --- */
        #setup-modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 3000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px 30px;
            border: 1px solid #888;
            width: 90%;
            max-width: 500px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            text-align: center;
            animation: fadeIn 0.3s;
        }
        .modal-content h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 22px;
        }
        .modal-content p {
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 20px;
        }
        @keyframes fadeIn {
            from {opacity: 0; transform: scale(0.95);}
            to {opacity: 1; transform: scale(1);}
        }

    </style>
</head>
<body>
    <!-- Header, Nav, Overlay (No Changes) -->
    <header class="header" id="appHeader" style="display:none;"><i class="material-icons menu-icon" onclick="toggleNav()">menu</i><h1>üèóÔ∏è PM's Salary Manager</h1><div id="userInfo"><span id="userName"></span><button onclick="signOut()" class="btn btn-danger" style="padding: 5px 10px; font-size: 12px; margin-left: 8px;">Sign Out</button></div></header>
    <nav class="side-nav" id="sideNav"><div class="nav-header"><h2>Digital Munshi</h2><p>Your Payroll Assistant</p></div><ul class="nav-buttons-container" id="navButtons"><li><button class="nav-btn" data-page="daily-entry"><i class="material-icons">edit_calendar</i> Daily Entry</button></li><li><button class="nav-btn" data-page="agreements"><i class="material-icons">gavel</i> Agreements</button></li><li><button class="nav-btn" data-page="salaries"><i class="material-icons">payments</i> Salaries</button></li><li><button class="nav-btn" data-page="bonus"><i class="material-icons">emoji_events</i> Bonus</button></li><li><button class="nav-btn" data-page="arrears"><i class="material-icons">calculate</i> Arrears</button></li><li><button class="nav-btn" data-page="leaves"><i class="material-icons">beach_access</i> Leaves</button></li><li><button class="nav-btn" data-page="settings"><i class="material-icons">settings</i> Settings</button></li></ul></nav>
    <div class="overlay" id="overlay" onclick="toggleNav()"></div>

    <main id="main-content">
        <!-- Login Page (No Changes) -->
        <div id="login-page" class="page active"><h2>Welcome to PM's Salary Manager</h2><p>Please sign in to continue</p><div class="form-group"><label>Email:</label><input type="email" id="loginEmail" placeholder="Enter your email"></div><div class="form-group"><label>Password:</label><input type="password" id="loginPassword" placeholder="Enter your password"></div><button onclick="signIn()" class="btn">Sign In</button><button onclick="showSignUp()" class="btn btn-success">Create New Account</button><div id="signUpForm" style="display: none; margin-top: 30px; padding-top: 30px; border-top: 2px solid #eee;"><h3>Create New Account</h3><div class="form-group"><label>Email:</label><input type="email" id="signupEmail" placeholder="Enter your email"></div><div class="form-group"><label>Password:</label><input type="password" id="signupPassword" placeholder="Choose a password (min 6 characters)"></div><div class="form-group"><label>Company/Business Name:</label><input type="text" id="companyName" placeholder="Enter your business name"></div><button onclick="signUp()" class="btn btn-success">Create Account</button><button onclick="hideSignUp()" class="btn">Back to Sign In</button></div></div>

        <!-- All Other Pages (No Changes) -->
        <div id="daily-entry" class="page">
            <!-- Daily entry content is unchanged -->
        </div>
        <div id="agreements" class="page"><h2>üìã Agreements Management</h2><p>Manage current and new agreement rates</p><div class="two-column"><div class="agreement-section"><h3>Current Agreement</h3><div class="rate-grid"><div class="form-group"><label>Ton Rate (Rs):</label><input type="number" id="currentTonRate"></div><div class="form-group"><label>Rest Rate (Rs):</label><input type="number" id="currentRestRate"></div><div class="form-group"><label>Layoff Rate (Rs):</label><input type="number" id="currentLayoffRate"></div><div class="form-group wagon-rate-field"><label>Wagon Rate (Rs):</label><input type="number" id="currentWagonRate"></div><div class="form-group"><label>Monthly Allowance (Rs):</label><input type="number" id="currentAllowance"></div><div class="form-group"><label>Annual Benefits (Rs):</label><input type="number" id="currentAnnualBenefits"></div></div></div><div class="agreement-section"><h3>New Agreement</h3><div class="rate-grid"><div class="form-group"><label>Ton Rate (Rs):</label><input type="number" id="newTonRate"></div><div class="form-group"><label>Rest Rate (Rs):</label><input type="number" id="newRestRate"></div><div class="form-group"><label>Layoff Rate (Rs):</label><input type="number" id="newLayoffRate"></div><div class="form-group wagon-rate-field"><label>Wagon Rate (Rs):</label><input type="number" id="newWagonRate"></div><div class="form-group"><label>Monthly Allowance (Rs):</label><input type="number" id="newAllowance"></div><div class="form-group"><label>Annual Benefits (Rs):</label><input type="number" id="newAnnualBenefits"></div></div></div></div><button onclick="saveAgreements()" class="btn">Save Agreements</button></div>
        <div id="settings" class="page">
            <h2>‚öôÔ∏è Settings</h2><p>Configure your application settings</p>
            <h3>General Settings</h3>
            <div class="form-group"><label>Number of Workers:</label><input type="number" id="workerCount" placeholder="8" readonly></div> <!-- MODIFIED: Made readonly -->
            <div class="form-group"><label>Agreement Start Date:</label><input type="date" id="agreementStartDate"></div>
            <div class="form-group"><label>Fiscal Year Start (MM-DD):</label><input type="text" id="fiscalYearStart" placeholder="10-10" pattern="[0-9]{2}-[0-9]{2}"></div>
            <div class="settings-section"><h3>Feature Controls</h3><!-- Unchanged --></div>
            <div class="settings-section">
                <h3>Manage Workers</h3>
                <p style="color: #6200EE; font-style: italic;">Workers ke naam pehli baar setup ke waqt lock kar diye gaye hain.</p>
                <div id="workersList"></div>
                <!-- MODIFIED: Add/Remove buttons are now controlled by loadWorkersList function -->
                <div id="settings-worker-buttons"></div>
            </div>
            <button onclick="saveSettings()" class="btn">Save Settings</button>
        </div>
        <!-- Other pages remain unchanged -->
    </main>
    
    <!-- NAYA: SETUP WIZARD HTML -->
    <div id="setup-wizard">
        <div class="setup-container">
            <!-- Step 1: Worker Setup -->
            <div id="worker-setup-step" class="setup-step">
                <h2>Welcome! Pehla Step Shuru Karain</h2>
                <p>Apne business ka bunyadi structure set karain. Yeh maloomat baad mein tabdeel nahi hongi.</p>
                <div class="form-group">
                    <label for="setup-worker-count" style="font-size: 16px;">Aapki team mein kitne workers hain?</label>
                    <input type="number" id="setup-worker-count" placeholder="Maslan: 8" oninput="generateSetupWorkerInputs()">
                </div>
                <div id="setup-workers-list"></div>
                <button onclick="saveWorkerSetup()" class="btn btn-success" id="save-workers-btn" disabled>Workers Mehfooz Karain aur Agay Barhain</button>
            </div>
            <!-- Step 2: Agreement Setup -->
            <div id="agreement-setup-step" class="setup-step">
                <h2>Aakhri Step: Agreement Set Karain</h2>
                <p>Apna mojooda salary agreement enter karain. Ghalat maloomat enter karne se bachne ke liye ehtiyat karain.</p>
                <div class="agreement-section" style="padding: 16px; margin: 0;">
                    <div class="rate-grid">
                        <div class="form-group"><label>Ton Rate (Rs):</label><input type="number" id="setup-tonRate"></div>
                        <div class="form-group"><label>Rest Rate (Rs):</label><input type="number" id="setup-restRate"></div>
                        <div class="form-group"><label>Layoff Rate (Rs):</label><input type="number" id="setup-layoffRate"></div>
                        <div class="form-group"><label>Wagon Rate (Rs):</label><input type="number" id="setup-wagonRate" value="0"></div>
                        <div class="form-group"><label>Monthly Allowance (Rs):</label><input type="number" id="setup-allowance"></div>
                        <div class="form-group"><label>Annual Benefits (Rs):</label><input type="number" id="setup-annualBenefits" value="0"></div>
                    </div>
                </div>
                <button onclick="completeFullSetup()" class="btn btn-success">Setup Mukammal Karain</button>
            </div>
        </div>
    </div>

    <!-- NAYA: SETUP POP-UP MODAL -->
    <div id="setup-modal">
        <div class="modal-content">
            <h3 id="modal-title">Zaroori Aagahi</h3>
            <p id="modal-message">Yeh aapke liye zaroori paigham hai.</p>
            <button class="btn" onclick="document.getElementById('setup-modal').style.display = 'none'">Main Samajh Gaya</button>
        </div>
    </div>


    <script>
        // --- MUKAMMAL JAVASCRIPT CODE ---
		
        let currentUser = null;
        let appData = { 
            salaries: {}, 
            workers: [],
            permissions: { viewableWorkers: [] },
            configs: { 
                workerCount: 8, 
                agreementStartDate: '2023-10-10', 
                fiscalYearStart: '10-10', 
                isPenaltyEnabled: false, 
                penaltyAmount: 231, 
                isWagonRateEnabled: false,
                isSetupComplete: false // NAYA: Setup state flag
            }, 
            agreements: { 
                current: { tonRate: 22, restRate: 1100, layoffRate: 549, wagonRate: 0, allowance: 20000, annualBenefits: 0 }, 
                new: { tonRate: 25, restRate: 1200, layoffRate: 600, wagonRate: 0, allowance: 26000, annualBenefits: 0 } 
            } 
        };
        
        // --- Core App Functions (Unchanged) ---
        function toggleNav() {
            document.getElementById('sideNav').classList.toggle('open');
            document.getElementById('overlay').classList.toggle('open');
        }

        function showPage(pageId) {
            // This function logic remains the same
        }

        // --- AUTHENTICATION & DATA FLOW (MODIFIED FOR SETUP) ---

        async function startApp() {
            try {
                const response = await fetch('/.netlify/functions/get-config');
                if (!response.ok) throw new Error('Configuration fetch failed.');
                const firebaseConfig = await response.json();
                firebase.initializeApp(firebaseConfig);

                firebase.auth().onAuthStateChanged(async (user) => {
                    if (user) {
                        currentUser = user;
                        await loadUserData(); // Load data first

                        // MODIFIED: Check if setup is complete
                        if (appData.configs && appData.configs.isSetupComplete) {
                            await showMainApp();
                        } else {
                            // If setup is not complete, start the wizard
                            startSetupWizard();
                        }
                    } else {
                        currentUser = null;
                        showLoginPage();
                    }
                });
                
                // --- Initial UI Setup Listeners (Unchanged) ---
            } catch (error) {
                console.error("Application start error:", error);
            }
        }
        
        document.addEventListener('DOMContentLoaded', startApp);

        async function showMainApp() {
            document.getElementById('setup-wizard').style.display = 'none'; // Hide wizard if it was open
            document.getElementById('login-page').classList.remove('active');
            document.getElementById('appHeader').style.display = 'flex';
            document.getElementById('userInfo').style.display = 'flex';
            document.getElementById('sideNav').style.display = 'flex';
            document.getElementById('userName').textContent = currentUser.displayName || currentUser.email;
            
            setupUI(); // Regular UI setup
            toggleWagonUIElements(appData.configs.isWagonRateEnabled);
            showPage('daily-entry');
        }

        function showLoginPage() {
            document.getElementById('setup-wizard').style.display = 'none';
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('login-page').classList.add('active');
            document.getElementById('appHeader').style.display = 'none';
            document.getElementById('sideNav').style.display = 'none';
            if (document.getElementById('sideNav').classList.contains('open')) {
                toggleNav();
            }
        }

        // --- User Account Functions (Sign In, Out, etc. Unchanged) ---
        function signIn() { /*...*/ }
        function signOut() { /*...*/ }
        function showSignUp() { /*...*/ }
        function hideSignUp() { /*...*/ }

        function signUp() {
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const companyName = document.getElementById('companyName').value.trim();
            if (!email || password.length < 6 || !companyName) {
                showAlert('Please provide valid details for all fields.', 'error');
                return;
            }

            firebase.auth().createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    return user.updateProfile({ displayName: companyName })
                    .then(() => {
                        currentUser = user;
                        // This will initialize data with isSetupComplete: false
                        return initializeNewUserData(); 
                    });
                })
                .then(() => {
                    showAlert('Account created! Please complete the initial setup.', 'success');
                    // onAuthStateChanged will automatically trigger the setup wizard
                })
                .catch((error) => {
                    console.error("Sign up error:", error);
                    showAlert(error.message, 'error');
                });
        }
        
        // --- FIREBASE DATABASE FUNCTIONS (MODIFIED) ---

        async function loadUserData() {
            // Unchanged logic, but now it correctly loads `isSetupComplete` flag
            // ...
        }
        
        async function saveUserData() {
            // Unchanged
            // ...
        }

        async function initializeNewUserData() {
            // MODIFIED: New users start with setup incomplete and empty workers array
            appData = { 
                salaries: {}, 
                workers: [], // Start with empty workers
                permissions: { viewableWorkers: [] },
                configs: { 
                    workerCount: 0, // Start with 0
                    agreementStartDate: new Date().toISOString().split('T')[0], 
                    fiscalYearStart: '10-10', 
                    isPenaltyEnabled: false, 
                    penaltyAmount: 231, 
                    isWagonRateEnabled: false,
                    isSetupComplete: false // IMPORTANT: New user flag
                }, 
                agreements: { 
                    current: {}, // Start with empty agreements
                    new: {} 
                }
            };
            await saveUserData();
        }

        // --- NAYA: SETUP WIZARD FUNCTIONS ---

        function startSetupWizard() {
            document.getElementById('login-page').classList.remove('active');
            document.getElementById('appHeader').style.display = 'none';
            document.getElementById('sideNav').style.display = 'none';
            
            const wizard = document.getElementById('setup-wizard');
            wizard.style.display = 'flex';
            
            showSetupStep('worker-setup-step');
            
            showSetupModal(
                "Pehla Qadam: Workers Setup",
                "Baraye meharbani apne workers ki tadaad aur unke naam enter karain. Yaad rahe, yeh naam sirf ek baar hi set kiye ja sakte hain aur baad mein tabdeel nahi ho sakte."
            );
        }

        function showSetupStep(stepId) {
            document.querySelectorAll('.setup-step').forEach(step => step.classList.remove('active'));
            document.getElementById(stepId).classList.add('active');
        }

        function showSetupModal(title, message) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('setup-modal').style.display = 'block';
        }

        function generateSetupWorkerInputs() {
            const count = parseInt(document.getElementById('setup-worker-count').value) || 0;
            const container = document.getElementById('setup-workers-list');
            const saveBtn = document.getElementById('save-workers-btn');
            
            container.innerHTML = '';
            if (count > 0 && count <= 50) { // Limit to 50 workers
                for (let i = 0; i < count; i++) {
                    const div = document.createElement('div');
                    div.className = 'form-group';
                    div.innerHTML = `
                        <label>Worker ${i + 1} ka Naam:</label>
                        <input type="text" class="setup-worker-name-input" placeholder="Naam likhain">
                    `;
                    container.appendChild(div);
                }
                saveBtn.disabled = false;
            } else {
                saveBtn.disabled = true;
                if(count > 50) container.innerHTML = '<p class="alert-error">Aap 50 se zyada workers nahi daal sakte.</p>';
            }
        }

        async function saveWorkerSetup() {
            const nameInputs = document.querySelectorAll('.setup-worker-name-input');
            const workerNames = [];
            let allNamesValid = true;

            nameInputs.forEach(input => {
                const name = input.value.trim();
                if (name) {
                    workerNames.push(name);
                } else {
                    allNamesValid = false;
                }
            });

            if (!allNamesValid || workerNames.length === 0) {
                showAlert("Baraye meharbani sabhi workers ke naam likhain.", "error");
                return;
            }

            // Lock the inputs and save
            nameInputs.forEach(input => {
                input.readOnly = true;
                input.classList.add('locked-input');
            });
            document.getElementById('setup-worker-count').readOnly = true;
            document.getElementById('setup-worker-count').classList.add('locked-input');
            document.getElementById('save-workers-btn').disabled = true;

            // Update appData
            appData.workers = workerNames;
            appData.configs.workerCount = workerNames.length;
            // Grant permission to view all workers by default for the admin/creator
            appData.permissions.viewableWorkers = [...workerNames]; 

            // Move to the next step
            showSetupStep('agreement-setup-step');
            showSetupModal(
                "Agla Qadam: Agreement",
                "Ab, baraye meharbani apna mojooda agreement set karain. Agar aap ne baad mein isay tabdeel kiya, to puranay hisaab ko durust karne ke liye aapko agreement ki shuruwaat ki tareekh se sari entries dobara karni par sakti hain."
            );
        }

        async function completeFullSetup() {
            const currentAgreement = {
                tonRate: parseFloat(document.getElementById('setup-tonRate').value) || 0,
                restRate: parseFloat(document.getElementById('setup-restRate').value) || 0,
                layoffRate: parseFloat(document.getElementById('setup-layoffRate').value) || 0,
                wagonRate: parseFloat(document.getElementById('setup-wagonRate').value) || 0,
                allowance: parseFloat(document.getElementById('setup-allowance').value) || 0,
                annualBenefits: parseFloat(document.getElementById('setup-annualBenefits').value) || 0,
            };

            // Basic validation
            if (currentAgreement.tonRate <= 0 || currentAgreement.restRate <= 0 || currentAgreement.layoffRate <= 0 || currentAgreement.allowance <= 0) {
                showAlert("Baraye meharbani agreement ki zaroori raqam (Ton, Rest, Layoff, Allowance) enter karain.", "error");
                return;
            }
            
            // Save data
            appData.agreements.current = currentAgreement;
            // Also set new agreement same as current for start
            appData.agreements.new = { ...currentAgreement };
            appData.configs.isSetupComplete = true; // Mark setup as complete

            await saveUserData(); // Save everything to Firebase
            
            showAlert("Setup mukammal ho gaya! Application mein khush amdeed.", "success");

            // Finally, show the main application
            await showMainApp();
        }

        // --- UI and OTHER FUNCTIONS (MODIFIED for Locked Settings) ---
        
        function setupUI() { loadWorkerAttendance(); loadAgreements(); loadPayPeriods(); loadFiscalYears(); loadSettings(); }
        
        function loadWorkersList() {
            const container = document.getElementById('workersList');
            const buttonsContainer = document.getElementById('settings-worker-buttons');
            container.innerHTML = '';
            buttonsContainer.innerHTML = ''; // Clear previous buttons

            const isSetupDone = appData.configs.isSetupComplete;

            (appData.workers || []).forEach((worker, index) => {
                const div = document.createElement('div');
                div.className = 'form-group';
                // MODIFIED: Input is always readonly after setup. No need for onchange.
                div.innerHTML = `<label>Worker ${index + 1}:</label>
                                 <input type="text" value="${worker}" readonly class="locked-input">`;
                container.appendChild(div);
            });

            // MODIFIED: Only show Add/Remove buttons if setup is NOT complete (which is never on this page now, but good practice)
            if (!isSetupDone) {
                 buttonsContainer.innerHTML = `<button onclick="addWorker()" class="btn btn-success">Add Worker</button>`;
            }
        }
        
        async function removeWorker(index) {
            // This function is now effectively disabled for end-users as the button won't show after setup.
            if(appData.configs.isSetupComplete) {
                showAlert("Workers setup ke baad tabdeel nahi ho sakte.", "error");
                return;
            }
            // ... original logic
        }
        
        async function updateWorkerName(index, newName) {
             // This function is also disabled as inputs are readonly.
            if(appData.configs.isSetupComplete) {
                showAlert("Workers setup ke baad tabdeel nahi ho sakte.", "error");
                return;
            }
            // ... original logic
        }

        function loadSettings() {
            if (!appData.configs) return;
            // MODIFIED: Worker count is now read-only after setup
            document.getElementById('workerCount').value = appData.configs.workerCount;
            document.getElementById('agreementStartDate').value = appData.configs.agreementStartDate;
            // ... rest of the function is the same
            loadWorkersList();
        }
        
        // --- All other functions (calculations, reports, etc.) remain unchanged ---
        // showAlert, saveDailyEntry, calculateDayEarnings, etc. are all the same.
        // ... (Rest of the original, unchanged JavaScript code)

    </script>
</body>
</html>
