<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PM's Salary Manager - Digital Munshi</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Firebase Libraries (already included) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-auth-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-database-compat.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-app-check-compat.min.js"></script>
    <style>
        :root {
            --primary-color: #6200EE;
            --primary-variant-color: #3700B3;
            --secondary-color: #03DAC6;
            --background-color: #f5f5f5;
            --surface-color: #FFFFFF;
            --on-primary-color: #FFFFFF;
            --on-surface-color: #000000;
            --error-color: #B00020;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Roboto', sans-serif; background-color: var(--background-color); color: var(--on-surface-color); }
        .header { background-color: var(--primary-color); color: var(--on-primary-color); padding: 0 16px; height: 64px; display: flex; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2); position: fixed; top: 0; left: 0; right: 0; z-index: 1000; }
        .header h1 { font-size: 20px; font-weight: 500; margin-left: 16px; }
        .menu-icon { cursor: pointer; padding: 8px; border-radius: 50%; transition: background-color 0.3s; }
        .menu-icon:hover { background-color: rgba(255,255,255,0.1); }
        #userInfo { margin-left: auto; display: none; align-items: center; }
        #userName { font-size: 14px; }
        .side-nav { position: fixed; top: 0; left: -300px; width: 280px; height: 100%; background-color: var(--surface-color); box-shadow: 2px 0 5px rgba(0,0,0,0.2); z-index: 1100; transition: left 0.3s ease-in-out; display: flex; flex-direction: column; }
        .side-nav.open { left: 0; }
        .nav-header { padding: 16px; background-color: var(--primary-variant-color); color: var(--on-primary-color); }
        .nav-header h2 { font-size: 18px; font-weight: 500; }
        .nav-header p { font-size: 12px; opacity: 0.8; }
        .nav-buttons-container { list-style: none; padding-top: 8px; flex-grow: 1; overflow-y: auto; }
        .nav-btn { display: flex; align-items: center; padding: 12px 16px; cursor: pointer; transition: background-color 0.3s; border: none; background: none; width: 100%; text-align: left; font-size: 14px; color: var(--on-surface-color); }
        .nav-btn .material-icons { margin-right: 24px; color: #5f6368; }
        .nav-btn:hover { background-color: rgba(0,0,0,0.05); }
        .nav-btn.active { background-color: rgba(98, 0, 238, 0.08); color: var(--primary-color); font-weight: 500; }
        .nav-btn.active .material-icons { color: var(--primary-color); }
        #main-content { padding: 76px 16px 16px 16px; width: 100%; }
        .page { display: none; background: var(--surface-color); padding: 16px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24); }
        .page.active { display: block; }
        .page > h2 { font-size: 20px; font-weight: 500; margin-bottom: 4px; color: var(--primary-color); }
        .page > p { margin-bottom: 12px; font-size: 14px; color: rgba(0,0,0,0.6); }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 4px; font-weight: 500; font-size: 14px; color: #4a5568; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(98, 0, 238, 0.2); }
        .btn { background-color: var(--primary-color); color: var(--on-primary-color); border: none; padding: 10px 16px; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 500; text-transform: uppercase; box-shadow: 0 2px 2px 0 rgba(0,0,0,0.14), 0 3px 1px -2px rgba(0,0,0,0.12), 0 1px 5px 0 rgba(0,0,0,0.2); transition: all 0.2s; margin: 4px; outline: none; display: inline-flex; align-items: center; justify-content: center; }
        .btn:hover { background-color: var(--primary-variant-color); box-shadow: 0 3px 3px 0 rgba(0,0,0,0.14), 0 1px 7px 0 rgba(0,0,0,0.12), 0 3px 1px -1px rgba(0,0,0,0.2); }
        .btn-danger { background-color: var(--error-color); }
        .btn-danger:hover { background-color: #9a001b; }
        .btn-success { background-color: #00C853; }
        .btn-success:hover { background-color: #00b048; }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1050; }
        .overlay.open { display: block; }
        .worker-checkbox { display: flex; align-items: center; margin: 0; padding: 8px; background: #f7fafc; border-radius: 4px; border: 1px solid #eee;}
        .worker-checkbox input { width: auto; margin-right: 8px; }
        
        .alert { 
            position: fixed; 
            bottom: 20px; 
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 25px; 
            border-radius: 6px; 
            border: 1px solid transparent; 
            z-index: 9999;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            font-size: 16px;
            min-width: 300px;
            text-align: center;
        }
        .alert-success { background: #c6f6d5; color: #22543d; border-color: #9ae6b4; }
        .alert-error { background: #fed7d7; color: #742a2a; border-color: #fc8181; }
        .alert-info { background: #bee3f8; color: #2a4365; border-color: #90cdf4; }
        
        .loading { text-align: center; padding: 20px; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 2s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #daily-entry-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        #daily-entry-left, #daily-entry-right { display: flex; flex-direction: column; }
        #daily-entry-right h3 { font-size: 16px; font-weight: 500; margin-bottom: 8px; }
        #workerAttendance { flex-grow: 1; overflow-y: auto; display: grid; gap: 8px; grid-template-columns: 1fr; padding-right: 8px; max-height: 230px; border: 1px solid #eee; padding: 8px; border-radius: 4px; }
        .action-buttons { margin-top: auto; padding-top: 16px; text-align: center; }
        .action-buttons .btn { width: 90%; max-width: 300px; }
        @media (max-width: 600px) { #daily-entry-layout { grid-template-columns: 1fr; } #workerAttendance { max-height: 150px; } }
        .two-column { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .agreement-section { background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0; border: 1px solid #e9ecef; }
        .agreement-section h3 { color: #495057; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #dee2e6; }
        .rate-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .report-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .report-card { background: #f7fafc; padding: 20px; border-radius: 8px; margin: 10px 0; border-left: 4px solid var(--primary-color); }
        .history-selector-container { margin-top: 24px; padding: 16px; border: 1px solid #e0e0e0; border-radius: 8px; background: #fafafa; }
        .history-table-container { margin-top: 16px; }
        .history-table-wrapper { overflow-x: auto; }
        .history-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .history-table th, .history-table td { padding: 8px; border: 1px solid #ddd; text-align: left; }
        .history-table th { background-color: #f2f2f2; }
        .history-table tr:nth-child(even) { background-color: #f9f9f9; }
        .no-history { color: #777; font-style: italic; }
        .settings-section { margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; }
        .checkbox-group { display: flex; align-items: center; margin-bottom: 16px; }
        .checkbox-group input { width: auto; margin-right: 10px; }
        .sub-setting { padding-left: 30px; }
        
        .setup-wizard-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; }
        .setup-wizard-overlay.active { display: flex; }
        .setup-wizard { background: var(--surface-color); border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 90%; max-width: 600px; max-height: 90vh; display: flex; flex-direction: column; }
        .wizard-header { padding: 16px 24px; border-bottom: 1px solid #e0e0e0; display: flex; align-items: center; }
        .wizard-header .material-icons { color: var(--primary-color); margin-right: 16px; }
        .wizard-header h2 { font-size: 20px; font-weight: 500; }
        .wizard-header p { font-size: 14px; color: rgba(0,0,0,0.6); }
        .wizard-body { padding: 24px; flex-grow: 1; overflow-y: auto; }
        .wizard-step { display: none; }
        .wizard-step.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .wizard-step h3 { margin-bottom: 8px; font-size: 18px; font-weight: 500; color: var(--primary-variant-color); }
        .wizard-step p.description { margin-bottom: 20px; font-size: 14px; color: #5f6368; }
        .wizard-footer { padding: 16px 24px; border-top: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; }
        .wizard-footer .btn .material-icons { margin-right: 8px; margin-left: -4px; }
        .wizard-footer .btn.btn-back .material-icons { margin-right: -4px; margin-left: 8px; }
        #wizard-worker-names-container { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        @media (max-width: 600px) { #wizard-worker-names-container { grid-template-columns: 1fr; } }
        .warning-box { background: #fffbe6; border: 1px solid #ffe58f; padding: 12px; border-radius: 4px; margin-bottom: 16px; display: flex; align-items: center; }
        .warning-box .material-icons { color: #faad14; margin-right: 10px; }

        #agreement-history-container { margin-top: 16px; }
        #agreement-history-table { width: 100%; border-collapse: collapse; }
        #agreement-history-table th, #agreement-history-table td { padding: 10px; border: 1px solid #ddd; text-align: center; font-size: 13px; }
        #agreement-history-table th { background-color: #f2f2f2; font-weight: 500; }
        .rate-history-actions button { padding: 4px 8px; font-size: 12px; margin: 0 4px;}
        #add-rate-form-container { display: none; padding: 16px; background: #f0f4ff; border: 1px solid #cce; margin-top: 16px; border-radius: 8px; }

    </style>
</head>
<body>
    <header class="header" id="appHeader" style="display:none;"><i class="material-icons menu-icon" onclick="toggleNav()">menu</i><h1>Pm&s Salary Manager</h1><div id="userInfo"><span id="userName"></span><button onclick="signOut()" class="btn btn-danger" style="padding: 5px 10px; font-size: 12px; margin-left: 8px;">Sign Out</button></div></header>
    <nav class="side-nav" id="sideNav"><div class="nav-header"><h2>Digital Munshi</h2><p>Your Payroll Assistant</p></div><ul class="nav-buttons-container" id="navButtons"><li><button class="nav-btn" data-page="daily-entry"><i class="material-icons">edit_calendar</i> Daily Entry</button></li><li><button class="nav-btn" data-page="agreements"><i class="material-icons">gavel</i> Agreements</button></li><li><button class="nav-btn" data-page="salaries"><i class="material-icons">payments</i> Salaries</button></li><li><button class="nav-btn" data-page="bonus"><i class="material-icons">emoji_events</i> Bonus</button></li><li><button class="nav-btn" data-page="arrears"><i class="material-icons">calculate</i> Arrears</button></li><li><button class="nav-btn" data-page="leaves"><i class="material-icons">beach_access</i> Leaves</button></li><li><button class="nav-btn" data-page="settings"><i class="material-icons">settings</i> Settings</button></li></ul></nav>
    <div class="overlay" id="overlay" onclick="toggleNav()"></div>

    <main id="main-content">
        <div id="login-page" class="page active"><h2>Welcome to Pm&s Salary Manager</h2><p>Please sign in to continue</p><div class="form-group"><label>Email:</label><input type="email" id="loginEmail" placeholder="Enter your email"></div><div class="form-group"><label>Password:</label><input type="password" id="loginPassword" placeholder="Enter your password"></div><button onclick="signIn()" class="btn">Sign In</button><button onclick="showSignUp()" class="btn btn-success">Create New Account</button><div id="signUpForm" style="display: none; margin-top: 30px; padding-top: 30px; border-top: 2px solid #eee;"><h3>Create New Account</h3><div class="form-group"><label>Email:</label><input type="email" id="signupEmail" placeholder="Enter your email"></div><div class="form-group"><label>Password:</label><input type="password" id="signupPassword" placeholder="Choose a password (min 6 characters)"></div><div class="form-group"><label>Your Good Name:</label><input type="text" id="companyName" placeholder="Enter your name"></div><button onclick="signUp()" class="btn btn-success">Create Account</button><button onclick="hideSignUp()" class="btn">Back to Sign In</button></div></div>

        <div id="daily-entry" class="page">
            <h2>üìù Daily Entry</h2><p>Record today's work details and attendance.</p>
            <div id="daily-entry-layout">
                <div id="daily-entry-left">
                    <div class="form-group"><label>Date:</label><input type="date" id="entryDate"></div>
                    <div class="form-group"><label>Day Type:</label><select id="dayType"><option value="work">Work Day</option><option value="rest">Rest Day</option><option value="special_overtime">Special Overtime</option></select></div>
                    <div id="workDetails"><div class="form-group"><label>Total Tonnage:</label><input type="number" id="tonnage" step="0.1" placeholder="e.g., 150.5"></div><div class="form-group" id="wagons-input-container"><label>Total Wagons:</label><input type="number" id="wagons" placeholder="e.g., 5"></div></div>
                    <div class="action-buttons"><button onclick="saveDailyEntry()" class="btn">Save Entry</button></div>
                </div>
                <div id="daily-entry-right"><h3>Worker Attendance</h3><div id="workerAttendance"><div class="loading"><p>Loading workers...</p></div></div></div>
            </div>
            <div class="history-selector-container"><div class="form-group"><label for="historyPeriodSelector">Select History Period:</label><select id="historyPeriodSelector" onchange="updateHistoryDisplay()"></select></div></div>
            <div id="entryResults"></div>
        </div>
        
        <div id="agreements" class="page">
            <h2>üìã Agreements Management</h2><p>Manage agreement rate history and future agreement details.</p>
            <div class="agreement-section">
                <h3>Current Agreement Rate History</h3>
                <p style="font-size: 14px; color: #5f6368; margin-top: -8px; margin-bottom: 12px;">Yahan aap ke maujooda agreement ki mukammal history hai. Jab bhi rates tabdeel hon, yahan ek naya record shamil karein.</p>
                <div id="agreement-history-container" class="history-table-wrapper"></div>
                <button onclick="showAddRateForm()" class="btn btn-success" style="margin-top: 16px;"><i class="material-icons" style="font-size: 18px; margin-right: 8px;">add_circle</i> Add New Rate Period</button>
                <div id="add-rate-form-container">
                    <h4 id="rate-form-title">Add New Rate Period</h4><input type="hidden" id="rate-edit-index">
                    <div class="rate-grid">
                        <div class="form-group"><label>Effective Date (Laagu Hone ki Tareekh)</label><input type="date" id="rateEffectiveDate"></div>
                        <div class="form-group"><label>Ton Rate (Rs):</label><input type="number" id="rateTonRate"></div>
                        <div class="form-group"><label>Rest Rate (Rs):</label><input type="number" id="rateRestRate"></div>
                        <div class="form-group"><label>Layoff Rate (Rs):</label><input type="number" id="rateLayoffRate"></div>
                        <div class="form-group wagon-rate-field"><label>Wagon Rate (Rs):</label><input type="number" id="rateWagonRate"></div>
                        <div class="form-group"><label>Monthly Allowance (Rs):</label><input type="number" id="rateAllowance"></div>
                        <div class="form-group"><label>Annual Benefits (Rs):</label><input type="number" id="rateAnnualBenefits"></div>
                    </div>
                    <button onclick="saveRatePeriod()" class="btn">Save Period</button><button onclick="hideAddRateForm()" class="btn btn-danger">Cancel</button>
                </div>
            </div>
            <div class="agreement-section">
                <h3>New Agreement (For Future Arrears)</h3>
                <div class="rate-grid">
                    <div class="form-group"><label>Ton Rate (Rs):</label><input type="number" id="newTonRate"></div>
                    <div class="form-group"><label>Rest Rate (Rs):</label><input type="number" id="newRestRate"></div>
                    <div class="form-group"><label>Layoff Rate (Rs):</label><input type="number" id="newLayoffRate"></div>
                    <div class="form-group wagon-rate-field"><label>Wagon Rate (Rs):</label><input type="number" id="newWagonRate"></div>
                    <div class="form-group"><label>Monthly Allowance (Rs):</label><input type="number" id="newAllowance"></div>
                    <div class="form-group"><label>Annual Benefits (Rs):</label><input type="number" id="newAnnualBenefits"></div>
                </div>
            </div>
            <button onclick="saveNewAgreement()" class="btn">Save New Agreement Details</button>
        </div>

        <div id="salaries" class="page"><h2>üí∞ Salary Reports</h2><p>View salary reports for different pay periods</p><div class="form-group"><label>Select Pay Period:</label><select id="payPeriod"><option value="">Select Period</option></select></div><button onclick="generateSalaryReport()" class="btn">Generate Report</button><div id="salaryResults"></div></div>
        <div id="bonus" class="page"><h2>üéÅ Annual Bonus & Gratuity</h2><p>Calculate annual bonus, gratuity and paid leaves bonus</p><div class="form-group"><label>Select Fiscal Year:</label><select id="fiscalYear"><option value="">Select Year</option></select></div><button onclick="calculateBonus()" class="btn">Calculate Bonus</button><div id="bonusResults"></div></div>
        
        <div id="arrears" class="page">
            <h2>üìä Arrears Calculation</h2><p>Calculate pending arrears based on agreement differences since the start date.</p>
            <button onclick="calculateArrears()" class="btn">Calculate Automatic Arrears</button><div id="arrearsResults"></div>
            <div class="settings-section">
                <h3>Calculate Arrears for a Specific Period</h3>
                <p>Select a start and end date to calculate salary and allowance arrears for that specific time frame.</p>
                <div class="two-column">
                    <div class="form-group"><label for="periodArrearsStartDate">Start Date:</label><input type="date" id="periodArrearsStartDate"></div>
                    <div class="form-group"><label for="periodArrearsEndDate">End Date:</label><input type="date" id="periodArrearsEndDate"></div>
                </div>
                <button onclick="calculateAndDisplayPeriodArrears()" class="btn">Calculate Period Arrears</button><div id="periodArrearsResults"></div>
            </div>
        </div>

        <div id="leaves" class="page"><h2>üèñÔ∏è Leaves Report</h2><p>Track annual leaves for all workers</p><div class="form-group"><label>Select Fiscal Year:</label><select id="leavesFiscalYear"><option value="">Select Year</option></select></div><button onclick="generateLeavesReport()" class="btn">Generate Leaves Report</button><div id="leavesResults"></div></div>
        
        <div id="settings" class="page">
            <h2>‚öôÔ∏è Settings</h2><p>Configure your application settings</p>
            <h3>General Settings</h3>
            <div class="form-group"><label>Number of Workers:</label><input type="number" id="workerCount" placeholder="8" disabled></div>
            <div class="form-group"><label>Agreement Start Date:</label><input type="date" id="agreementStartDate"></div>
            <div class="form-group"><label>Fiscal Year Start (MM-DD):</label><input type="text" id="fiscalYearStart" placeholder="10-10" pattern="[0-9]{2}-[0-9]{2}" disabled></div>
            <div class="settings-section">
                <h3>Leave Settings</h3>
                <div class="two-column">
                    <div class="form-group"><label for="unpaidLeaves">Total Unpaid Leaves (Salana)</label><input type="number" id="unpaidLeaves" placeholder="e.g., 20"></div>
                    <div class="form-group"><label for="paidLeaves">Total Paid Leaves (Salana)</label><input type="number" id="paidLeaves" placeholder="e.g., 12"></div>
                </div>
            </div>
            <div class="settings-section">
                <h3>Feature Controls</h3>
                <div class="checkbox-group"><input type="checkbox" id="enableWagonRate"><label for="enableWagonRate">Enable Wagon Rate Calculation</label></div>
                <div class="checkbox-group"><input type="checkbox" id="enablePenalty"><label for="enablePenalty">Enable Excess Leave Penalty</label></div>
                <div class="sub-setting" id="penaltyAmountContainer" style="display: none;"><div class="form-group"><label for="penaltyAmount">Penalty Amount (Normal Day)</label><input type="number" id="penaltyAmount"></div></div>
            </div>
            <div class="settings-section">
                <h3>Manage Workers</h3>
                <div class="warning-box"><i class="material-icons">warning</i><span>Worker ke naam tabdeel karne se purane data aur hisaab par asar par sakta hai. Ehtiyat se kaam lein.</span></div>
                <div id="workersList"></div>
                <div id="unlock-prompt">
                    <div class="form-group">
                        <label>Worker settings ko unlock karne ke liye neeche diya gaya jumla type karein:</label>
                        <input type="text" id="unlock-key-input" placeholder="Yahan type karein..."><p><small>"unlock worker settings ke button ko unhide karo"</small></p>
                    </div>
                    <button onclick="checkUnlockKey()" class="btn">Unhide Karein</button>
                </div>
                <div id="worker-management-buttons" style="display:none;">
                    <button onclick="unlockWorkerSettings()" class="btn">Unlock Worker Settings</button>
                </div>
            </div>
            <button onclick="saveSettings()" class="btn">Save Settings</button>
        </div>
    </main>

    <div id="setup-wizard-overlay" class="setup-wizard-overlay">
        <div class="setup-wizard">
            <div class="wizard-header"><i class="material-icons">auto_awesome</i><div><h2>Welcome to Digital Munshi!</h2><p>Let's set up your account in a few simple steps.</p></div></div>
            <div class="wizard-body">
                <div id="wizard-step-1" class="wizard-step"><h3>Step 1: Team Size</h3><p class="description">Aapki team mein kitne workers hain? <strong><span style="color: var(--error-color);">Warning:</span> Yeh taadad baad mein tabdeel nahi ki ja sakegi. Baraye meharbani sahih taadad likhein.</strong></p><div class="form-group"><label for="wizardWorkerCount"><i class="material-icons" style="vertical-align: middle; font-size: 18px;">group</i> Total Workers</label><input type="number" id="wizardWorkerCount" placeholder="e.g., 8" value="8"></div></div>
                <div id="wizard-step-2" class="wizard-step"><h3>Step 2: Worker Names</h3><p class="description">Workers ke name likhain. <strong><span style="color: var(--error-color);">Warning: </span> Workers ke name baad mein tabdeel nahi ki ja sakeinge. lihaaza ehtiyat se likhein.</strong></p><div id="wizard-worker-names-container"></div></div>
                <div id="wizard-step-3" class="wizard-step">
                    <h3>Step 3: Agreement & Leave Details</h3><p class="description">Apne pehle agreement ke rates aur salana chuttiyan yahan darj karein.</p>
                    <div class="rate-grid">
                        <div class="form-group"><label>Ton Rate (Rs):</label><input type="number" id="wizardTonRate" value="22"></div>
                        <div class="form-group"><label>Rest Rate (Rs):</label><input type="number" id="wizardRestRate" value="1100"></div>
                        <div class="form-group"><label>Layoff Rate (Rs):</label><input type="number" id="wizardLayoffRate" value="549"></div>
                        <div class="form-group"><label>Monthly Allowance (Rs):</label><input type="number" id="wizardAllowance" value="17870"></div>
                        <div class="form-group"><label>Annual Benefits (Rs):</label><input type="number" id="wizardAnnualBenefits" value="0"></div>
                        <div class="form-group"><label>Unpaid Leaves:</label><input type="number" id="wizardUnpaidLeaves" value="20"></div>
                        <div class="form-group"><label>Paid Leaves:</label><input type="number" id="wizardPaidLeaves" value="12"></div>
                    </div>
                </div>
                <div id="wizard-step-4" class="wizard-step">
                     <h3>Step 4: Agreement Start Date</h3><p class="description">Batayein ke yeh agreement kis tareekh se shuru hua hai. (agreement ki start date set karain)</p>
                     <div class="form-group"><label for="wizardAgreementStartDate"><i class="material-icons" style="vertical-align: middle; font-size: 18px;">event</i> Start Date</label><input type="date" id="wizardAgreementStartDate"></div>
                    <div class="warning-box"><i class="material-icons">info</i><span>Is tareekh ke baad aap tamam settings ko "Settings" page se tabdeel kar sakte hain.</span></div>
                </div>
            </div>
            <div class="wizard-footer"><button id="wizard-back-btn" onclick="wizardNavigate('back')" class="btn btn-danger" style="display: none;"><i class="material-icons">arrow_back</i> Back</button><button id="wizard-next-btn" onclick="wizardNavigate('next')" class="btn"><i class="material-icons">arrow_forward</i> Next</button><button id="wizard-finish-btn" onclick="finishSetup()" class="btn btn-success" style="display: none;"><i class="material-icons">done_all</i> Finish Setup</button></div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let isWorkerSettingsLocked = true;
        let currentWizardStep = 1;

        let appData = { 
            salaries: {}, workers: [], permissions: { viewableWorkers: [] },
            configs: { workerCount: 8, agreementStartDate: '2023-10-10', fiscalYearStart: '10-10', isPenaltyEnabled: false, penaltyAmount: 231, isWagonRateEnabled: false, isSetupComplete: false, unpaidLeaves: 20, paidLeaves: 12 }, 
            agreements: { 
                history: [{ effectiveDate: '2023-10-10', tonRate: 22, restRate: 1100, layoffRate: 549, wagonRate: 0, allowance: 17870, annualBenefits: 0 }],
                new: { tonRate: 25, restRate: 1200, layoffRate: 600, wagonRate: 0, allowance: 26000, annualBenefits: 0 } 
            } 
        };
        
        function toggleNav() {
            document.getElementById('sideNav').classList.toggle('open');
            document.getElementById('overlay').classList.toggle('open');
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            const activeButton = document.querySelector(`.nav-btn[data-page="${pageId}"]`);
            if (activeButton) activeButton.classList.add('active');
            if (window.innerWidth < 960 && document.getElementById('sideNav').classList.contains('open')) toggleNav();
            switch(pageId) {
                case 'daily-entry': loadWorkerAttendance(); populateHistorySelector(); updateHistoryDisplay(); break;
                case 'agreements': loadAgreements(); break;
                case 'salaries': loadPayPeriods(); break;
                case 'bonus': case 'leaves': loadFiscalYears(); break;
                case 'settings': loadSettings(); break;
            }
        }

        async function startApp() {
            try {
                const response = await fetch('/.netlify/functions/get-config');
                if (!response.ok) throw new Error('Configuration fetch failed.');
                const firebaseConfig = await response.json();
                firebase.initializeApp(firebaseConfig);
                try { firebase.appCheck().activate(firebaseConfig.reCAPTCHAKey, true); } catch (err) { console.error("App Check activation failed", err); }
                firebase.auth().onAuthStateChanged(async (user) => {
                    if (user) {
                        currentUser = user;
                        await loadUserData();
                        if (appData.configs && appData.configs.isSetupComplete) await showMainApp();
                        else startSetupWizard();
                    } else {
                        currentUser = null;
                        showLoginPage();
                    }
                });
                document.querySelectorAll('.nav-btn').forEach(btn => btn.addEventListener('click', () => showPage(btn.dataset.page)));
                document.getElementById('entryDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('dayType').addEventListener('change', function() { document.getElementById('workDetails').style.display = this.value === 'rest' ? 'none' : 'block'; });
                document.getElementById('enablePenalty').addEventListener('change', (e) => { document.getElementById('penaltyAmountContainer').style.display = e.target.checked ? 'block' : 'none'; });
                document.getElementById('enableWagonRate').addEventListener('change', (e) => { toggleWagonUIElements(e.target.checked); });
            } catch (error) {
                console.error("Application start error:", error);
                document.getElementById('main-content').innerHTML = `<div class="alert alert-error"><h2>Application Error</h2><p>Application configuration could not be loaded. Please try again later.</p></div>`;
            }
        }
        
        document.addEventListener('DOMContentLoaded', startApp);

        async function showMainApp() {
            document.getElementById('login-page').classList.remove('active');
            document.getElementById('setup-wizard-overlay').classList.remove('active');
            document.getElementById('appHeader').style.display = 'flex';
            document.getElementById('userInfo').style.display = 'flex';
            document.getElementById('sideNav').style.display = 'flex';
            document.getElementById('userName').textContent = currentUser.displayName || currentUser.email;
            setupUI();
            toggleWagonUIElements(appData.configs.isWagonRateEnabled);
            showPage('daily-entry');
        }

        function showLoginPage() {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('login-page').classList.add('active');
            document.getElementById('appHeader').style.display = 'none';
            document.getElementById('sideNav').style.display = 'none';
            document.getElementById('setup-wizard-overlay').classList.remove('active');
            if (document.getElementById('sideNav').classList.contains('open')) toggleNav();
        }

        function signIn() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            if (!email || !password) { showAlert('Please enter both email and password', 'error'); return; }
            firebase.auth().signInWithEmailAndPassword(email, password).catch((error) => showAlert(error.message, 'error'));
        }

        function signUp() {
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const companyName = document.getElementById('companyName').value.trim();
            if (!email || password.length < 6) { showAlert('Provide a valid email and a password of at least 6 characters.', 'error'); return; }
            if (!companyName) { showAlert('Please enter your Company or Business Name.', 'error'); return; }
            firebase.auth().createUserWithEmailAndPassword(email, password)
                .then((userCredential) => userCredential.user.updateProfile({ displayName: companyName }))
                .catch((error) => showAlert(error.message, 'error'));
        }

        function signOut() { firebase.auth().signOut().catch((error) => showAlert(error.message, 'error')); }
        function showSignUp() { document.getElementById('signUpForm').style.display = 'block'; }
        function hideSignUp() { document.getElementById('signUpForm').style.display = 'none'; }
        
        async function loadUserData() {
            if (!currentUser) return;
            const userRef = firebase.database().ref('users/' + currentUser.uid);
            try {
                const snapshot = await userRef.once('value');
                if (snapshot.exists()) {
                    const savedData = snapshot.val();
                    if (savedData.agreements && savedData.agreements.current && !savedData.agreements.history) {
                        console.log("Old data structure found. Migrating to new 'history' structure.");
                        savedData.agreements.history = [{ ...savedData.agreements.current, effectiveDate: savedData.configs.agreementStartDate || '2023-01-01' }];
                        delete savedData.agreements.current;
                        showAlert("Data structure updated to support rate history.", "info");
                    }
                    appData = { ...appData, ...savedData,
                        permissions: { ...(appData.permissions || {}), ...(savedData.permissions || {}) },
                        configs: { ...appData.configs, ...(savedData.configs || {}) },
                        agreements: { history: savedData.agreements?.history || appData.agreements.history, new: { ...appData.agreements.new, ...(savedData.agreements?.new || {}) } },
                        salaries: savedData.salaries || {}, workers: savedData.workers || []
                    };
                    if (!appData.permissions.viewableWorkers || appData.permissions.viewableWorkers.length === 0) {
                        appData.permissions.viewableWorkers = appData.workers.length > 0 ? [appData.workers[0]] : [];
                    }
                } else { await initializeNewUserData(); }
            } catch (error) {
                console.error("Error loading user data:", error);
                showAlert("Could not load your data from the server.", "error");
            }
        }
        
        async function saveUserData() {
            if (!currentUser) return;
            try {
                if (appData.agreements && appData.agreements.history) {
                    appData.agreements.history.sort((a, b) => new Date(b.effectiveDate) - new Date(a.effectiveDate));
                }
                await firebase.database().ref('users/' + currentUser.uid).set(appData);
            } catch (error) {
                console.error("Error saving user data:", error);
                showAlert("Failed to save data. Please check your connection.", "error");
            }
        }
        
        async function initializeNewUserData() {
            const todayStr = new Date().toISOString().split('T')[0];
            appData = { 
                salaries: {}, workers: ['Worker 1', 'Worker 2', 'Worker 3', 'Worker 4', 'Worker 5', 'Worker 6', 'Worker 7', 'Worker 8'], 
                permissions: { viewableWorkers: ['Worker 1'] },
                configs: { workerCount: 8, agreementStartDate: todayStr, fiscalYearStart: '10-10', isPenaltyEnabled: false, penaltyAmount: 231, isWagonRateEnabled: false, isSetupComplete: false, unpaidLeaves: 20, paidLeaves: 12 }, 
                agreements: { 
                    history: [{ effectiveDate: todayStr, tonRate: 22, restRate: 1100, layoffRate: 549, wagonRate: 0, allowance: 17870, annualBenefits: 0 }], 
                    new: { tonRate: 25, restRate: 1200, layoffRate: 600, wagonRate: 0, allowance: 26000, annualBenefits: 0 } 
                }
            };
        }

        function startSetupWizard() {
            document.getElementById('login-page').classList.remove('active');
            document.getElementById('appHeader').style.display = 'none';
            document.getElementById('setup-wizard-overlay').classList.add('active');
            document.getElementById('wizardAgreementStartDate').value = new Date().toISOString().split('T')[0];
            currentWizardStep = 1; updateWizardView();
        }

        function wizardNavigate(direction) {
            if (direction === 'next') {
                if (currentWizardStep === 1) {
                    const count = parseInt(document.getElementById('wizardWorkerCount').value);
                    if (!count || count <= 0) { showAlert('Please enter a valid number of workers.', 'error'); return; }
                    generateWizardWorkerNames(count);
                }
                if (currentWizardStep < 4) currentWizardStep++;
            } else if (direction === 'back') {
                if (currentWizardStep > 1) currentWizardStep--;
            }
            updateWizardView();
        }

        function updateWizardView() {
            document.querySelectorAll('.wizard-step').forEach(step => step.classList.remove('active'));
            document.getElementById(`wizard-step-${currentWizardStep}`).classList.add('active');
            document.getElementById('wizard-back-btn').style.display = currentWizardStep > 1 ? 'inline-flex' : 'none';
            document.getElementById('wizard-next-btn').style.display = currentWizardStep < 4 ? 'inline-flex' : 'none';
            document.getElementById('wizard-finish-btn').style.display = currentWizardStep === 4 ? 'inline-flex' : 'none';
        }

        function generateWizardWorkerNames(count) {
            const container = document.getElementById('wizard-worker-names-container'); container.innerHTML = '';
            for (let i = 0; i < count; i++) {
                const formGroup = document.createElement('div'); formGroup.className = 'form-group';
                formGroup.innerHTML = `<label for="wizard_worker_${i}">Worker ${i + 1} Name</label><input type="text" id="wizard_worker_${i}" value="Worker ${i + 1}">`;
                container.appendChild(formGroup);
            }
        }

        async function finishSetup() {
            const workerCount = parseInt(document.getElementById('wizardWorkerCount').value);
            const workerNames = [];
            for (let i = 0; i < workerCount; i++) {
                const name = document.getElementById(`wizard_worker_${i}`).value.trim();
                if (name) workerNames.push(name); else { showAlert(`Please provide a name for Worker ${i + 1}.`, 'error'); return; }
            }
            const agreementStartDate = document.getElementById('wizardAgreementStartDate').value;
            if (!agreementStartDate) { showAlert('Please select the agreement start date.', 'error'); return; }
            appData.configs.workerCount = workerCount; appData.workers = workerNames;
            appData.permissions.viewableWorkers = workerNames.length > 0 ? [workerNames[0]] : [];
            const firstRatePeriod = {
                effectiveDate: agreementStartDate,
                tonRate: parseFloat(document.getElementById('wizardTonRate').value) || 0,
                restRate: parseFloat(document.getElementById('wizardRestRate').value) || 0,
                layoffRate: parseFloat(document.getElementById('wizardLayoffRate').value) || 0,
                allowance: parseFloat(document.getElementById('wizardAllowance').value) || 0,
                annualBenefits: parseFloat(document.getElementById('wizardAnnualBenefits').value) || 0,
                wagonRate: 0 
            };
            appData.agreements.history = [firstRatePeriod];
            appData.configs.unpaidLeaves = parseInt(document.getElementById('wizardUnpaidLeaves').value) || 20;
            appData.configs.paidLeaves = parseInt(document.getElementById('wizardPaidLeaves').value) || 12;
            const agreementDate = new Date(agreementStartDate + "T00:00:00");
            const fiscalMonth = (agreementDate.getMonth() + 1).toString().padStart(2, '0');
            const fiscalDay = agreementDate.getDate().toString().padStart(2, '0');
            appData.configs.agreementStartDate = agreementStartDate; appData.configs.fiscalYearStart = `${fiscalMonth}-${fiscalDay}`;
            appData.configs.isSetupComplete = true;
            await saveUserData();
            showAlert('Setup complete! Welcome to your dashboard.', 'success');
            await showMainApp();
        }

        function getRatesForDate(dateStr) {
            if (!appData.agreements || !appData.agreements.history || appData.agreements.history.length === 0) return { tonRate: 0, restRate: 0, layoffRate: 0, wagonRate: 0, allowance: 0, annualBenefits: 0 };
            const targetDate = new Date(dateStr + "T00:00:00");
            for (const period of appData.agreements.history) {
                if (targetDate >= new Date(period.effectiveDate + "T00:00:00")) return period;
            }
            return appData.agreements.history[appData.agreements.history.length - 1];
        }

        function toggleWagonUIElements(isEnabled) {
            const displayStyle = isEnabled ? 'block' : 'none';
            document.getElementById('wagons-input-container').style.display = displayStyle;
            document.querySelectorAll('.wagon-rate-field').forEach(el => el.style.display = displayStyle);
        }

        function setupUI() { loadWorkerAttendance(); loadPayPeriods(); loadFiscalYears(); loadSettings(); }
        
        function loadWorkerAttendance() {
            const container = document.getElementById('workerAttendance'); container.innerHTML = '';
            if(!appData.workers || appData.workers.length === 0){ container.innerHTML = "<p>No workers found.</p>"; return; }
            appData.workers.forEach(worker => {
                const div = document.createElement('div'); div.className = 'worker-checkbox';
                div.innerHTML = `<input type="checkbox" id="worker_${worker.replace(/\s/g, '_')}" checked> <label for="worker_${worker.replace(/\s/g, '_')}">${worker}</label>`;
                container.appendChild(div);
            });
        }
        
        async function saveDailyEntry() {
            const date = document.getElementById('entryDate').value;
            const dayType = document.getElementById('dayType').value;
            const tonnage = parseFloat(document.getElementById('tonnage').value) || 0;
            const wagons = parseInt(document.getElementById('wagons').value) || 0;
            if (!date) { showAlert('Please select a date', 'error'); return; }
            let presentWorkers = (dayType === 'rest') ? [...appData.workers] : appData.workers.filter(w => document.getElementById(`worker_${w.replace(/\s/g, '_')}`).checked);
            const ratesForThisDay = getRatesForDate(date);
            const earnings = calculateDayEarnings(date, dayType, tonnage, wagons, presentWorkers, ratesForThisDay);
            if (!appData.salaries) appData.salaries = {};
            appData.salaries[date] = { date, type: dayType, tonnage, wagons, presentWorkers, earnings };
            await saveUserData();
            populateHistorySelector(); updateHistoryDisplay();
            showAlert('Daily entry saved successfully!', 'success');
        }

        function calculateDayEarnings(entryDate, dayType, tonnage, wagons, presentWorkers, rates) {
            const earnings = {}; const allWorkers = appData.workers;
            const absentWorkers = allWorkers.filter(w => !presentWorkers.includes(w));
            let penaltyPerPresentWorker = 0; const penaltyTriggeringAbsentees = [];
            if (appData.configs.isPenaltyEnabled && absentWorkers.length > 0) {
                const [fiscalYearStart, fiscalYearEnd] = getCurrentFiscalYearDates(entryDate); 
                const totalAllowedLeaves = (appData.configs.unpaidLeaves || 20) + (appData.configs.paidLeaves || 12);
                absentWorkers.forEach(worker => {
                    if (getWorkerTotalLeaves(worker, fiscalYearStart, fiscalYearEnd) >= totalAllowedLeaves) penaltyTriggeringAbsentees.push(worker);
                });
                if (penaltyTriggeringAbsentees.length > 0) {
                    const totalPenalty = penaltyTriggeringAbsentees.length * appData.configs.penaltyAmount * (dayType === 'special_overtime' ? 2 : 1);
                    if (presentWorkers.length > 0) penaltyPerPresentWorker = totalPenalty / presentWorkers.length;
                }
            }
            let grossEarningPerWorker = 0;
            if (presentWorkers.length > 0 && dayType !== 'rest') {
                grossEarningPerWorker = (tonnage * rates.tonRate) / presentWorkers.length + (appData.configs.isWagonRateEnabled ? (wagons * rates.wagonRate) / presentWorkers.length : 0);
            }
            allWorkers.forEach(worker => {
                if (presentWorkers.includes(worker)) {
                    let adjustedEarning = grossEarningPerWorker - penaltyPerPresentWorker;
                    let minGuarantee = rates.layoffRate;
                    if (dayType === 'special_overtime') {
                        const overtimeGross = ((tonnage * rates.tonRate) / presentWorkers.length * 2) + rates.layoffRate + (appData.configs.isWagonRateEnabled ? (wagons * rates.wagonRate) / presentWorkers.length : 0);
                        adjustedEarning = overtimeGross - penaltyPerPresentWorker;
                        minGuarantee = rates.layoffRate * 3;
                    } else if (dayType === 'rest') {
                        adjustedEarning = rates.restRate;
                        minGuarantee = rates.restRate;
                    }
                    earnings[worker] = Math.max(adjustedEarning, minGuarantee);
                } else { earnings[worker] = penaltyTriggeringAbsentees.includes(worker) ? 0 : rates.layoffRate; }
            });
            return earnings;
        }

        function getCurrentFiscalYearDates(referenceDateStr) {
            const referenceDate = referenceDateStr ? new Date(referenceDateStr + "T00:00:00") : new Date();
            const [fiscalMonth, fiscalDay] = appData.configs.fiscalYearStart.split('-').map(Number);
            let fiscalYearStartYear = referenceDate.getFullYear();
            if (referenceDate < new Date(fiscalYearStartYear, fiscalMonth - 1, fiscalDay)) fiscalYearStartYear--;
            const fiscalYearStartDate = new Date(fiscalYearStartYear, fiscalMonth - 1, fiscalDay);
            const fiscalYearEndDate = new Date(fiscalYearStartYear + 1, fiscalMonth - 1, fiscalDay - 1);
            return [fiscalYearStartDate, fiscalYearEndDate];
        }

        function getWorkerTotalLeaves(workerName, fiscalYearStartDate, fiscalYearEndDate) {
            let leaveCount = 0;
            Object.values(appData.salaries || {}).forEach(entry => {
                const entryDate = new Date(entry.date + "T00:00:00");
                if (entryDate >= fiscalYearStartDate && entryDate <= fiscalYearEndDate) {
                    if (entry.type !== 'rest' && !entry.presentWorkers.includes(workerName)) leaveCount++;
                }
            });
            return leaveCount;
        }

        function populateHistorySelector() {
            const selector = document.getElementById('historyPeriodSelector'), currentValue = selector.value; selector.innerHTML = ''; if (!appData.configs || !appData.configs.agreementStartDate) return;
            const agreementStart = new Date(appData.configs.agreementStartDate + "T00:00:00"); let loopDate = new Date(agreementStart.getFullYear(), agreementStart.getMonth(), 1); const today = new Date();
            let defaultValue = currentValue; if (!defaultValue) { const d = today, y = d.getFullYear(), m = (d.getMonth() + 1).toString().padStart(2, '0'); defaultValue = d.getDate() <= 15 ? `${y}-${m}-01,${y}-${m}-15` : `${y}-${m}-16,${new Date(y, d.getMonth() + 1, 0).getDate()}`; }
            let optionsHtml = ''; while (loopDate <= today) {
                const year = loopDate.getFullYear(), month = (loopDate.getMonth() + 1).toString().padStart(2, '0'), monthName = loopDate.toLocaleString('default', { month: 'long' }), lastDay = new Date(year, loopDate.getMonth() + 1, 0).getDate();
                optionsHtml = `<option value="${year}-${month}-16,${year}-${month}-${lastDay}">${monthName} ${year} (16 - ${lastDay})</option>` + optionsHtml;
                optionsHtml = `<option value="${year}-${month}-01,${year}-${month}-15">${monthName} ${year} (1 - 15)</option>` + optionsHtml;
                loopDate.setMonth(loopDate.getMonth() + 1);
            } selector.innerHTML = optionsHtml; if (selector.querySelector(`option[value="${defaultValue}"]`)) { selector.value = defaultValue; }
        }

        function updateHistoryDisplay() {
            const selector = document.getElementById('historyPeriodSelector'); if (!selector.value) { document.getElementById('entryResults').innerHTML = ''; return; }
            const [startDateStr, endDateStr] = selector.value.split(','); const startDate = new Date(startDateStr + "T00:00:00"), endDate = new Date(endDateStr + "T00:00:00");
            const periodEntries = Object.values(appData.salaries || {}).filter(e => { const d = new Date(e.date + "T00:00:00"); return d >= startDate && d <= endDate; }).sort((a,b) => new Date(b.date) - new Date(a.date));
            document.getElementById('entryResults').innerHTML = generateHistoryTable(periodEntries, `History for: ${selector.options[selector.selectedIndex].text}`);
        }

        function generateHistoryTable(entries, title) {
            let tableHtml = `<div class="history-table-container"><h3>${title}</h3>`; if (entries.length === 0) return tableHtml + `<p class="no-history">No entries for this period.</p></div>`;
            tableHtml += `<div class="history-table-wrapper"><table class="history-table"><thead><tr><th>Date</th><th>Tonnage</th><th>Workers</th><th>Pay/Worker</th></tr></thead><tbody>`;
            entries.forEach(entry => {
                const ratesForDay = getRatesForDate(entry.date); let singlePay = 0; 
                if (entry.presentWorkers?.length > 0) singlePay = entry.earnings[entry.presentWorkers[0]] || 0; 
                else if (entry.type === 'rest') singlePay = ratesForDay.restRate; 
                else if (appData.workers?.length > 0) singlePay = entry.earnings[appData.workers[0]] || 0; 
                tableHtml += `<tr><td>${entry.date}</td><td>${entry.tonnage > 0 ? entry.tonnage.toFixed(2) : '-'}</td><td>${entry.presentWorkers?.length || 0} / ${appData.workers?.length || 0}</td><td>${singlePay.toFixed(2)}</td></tr>`; 
            });
            return tableHtml + `</tbody></table></div></div>`;
        }

        function loadAgreements() {
            const container = document.getElementById('agreement-history-container');
            const history = appData.agreements.history || [];
            history.sort((a, b) => new Date(b.effectiveDate) - new Date(a.effectiveDate));
            let tableHtml = `<table id="agreement-history-table"><thead><tr><th>Effective Date</th><th>Ton</th><th>Rest</th><th>Layoff</th><th>Allowance</th><th>Actions</th></tr></thead><tbody>`;
            if (history.length === 0) { tableHtml += `<tr><td colspan="6">No rate history found. Add a rate period.</td></tr>`; } 
            else {
                history.forEach((period, index) => {
                    tableHtml += `<tr><td>${period.effectiveDate}</td><td>${period.tonRate}</td><td>${period.restRate}</td><td>${period.layoffRate}</td><td>${period.allowance}</td>
                        <td class="rate-history-actions">
                            <button class="btn" onclick="editRatePeriod(${index})"><i class="material-icons" style="font-size:14px;">edit</i></button>
                            <button class="btn btn-danger" onclick="deleteRatePeriod(${index})"><i class="material-icons" style="font-size:14px;">delete</i></button>
                        </td></tr>`;
                });
            }
            tableHtml += `</tbody></table>`; container.innerHTML = tableHtml;
            Object.keys(appData.agreements.new).forEach(key => {
                const element = document.getElementById(`new${key.charAt(0).toUpperCase() + key.slice(1)}`);
                if(element) element.value = appData.agreements.new[key];
            });
            hideAddRateForm();
        }

        function showAddRateForm(isEdit = false) {
            document.getElementById('add-rate-form-container').style.display = 'block';
            if (!isEdit) {
                document.getElementById('rate-form-title').textContent = 'Add New Rate Period';
                document.getElementById('rate-edit-index').value = '-1';
                const latestRates = getRatesForDate(new Date().toISOString().split('T')[0]);
                Object.keys(latestRates).forEach(key => {
                    const input = document.getElementById(`rate${key.charAt(0).toUpperCase() + key.slice(1)}`);
                    if(input) input.value = latestRates[key];
                });
                document.getElementById('rateEffectiveDate').value = new Date().toISOString().split('T')[0];
            }
        }

        function hideAddRateForm() { document.getElementById('add-rate-form-container').style.display = 'none'; }

        function editRatePeriod(index) {
            const periodToEdit = appData.agreements.history[index]; if (!periodToEdit) return;
            showAddRateForm(true);
            document.getElementById('rate-form-title').textContent = 'Edit Rate Period';
            document.getElementById('rate-edit-index').value = index;
            Object.keys(periodToEdit).forEach(key => {
                const input = document.getElementById(`rate${key.charAt(0).toUpperCase() + key.slice(1)}`);
                if(input) input.value = periodToEdit[key];
            });
        }

        async function saveRatePeriod() {
            const index = parseInt(document.getElementById('rate-edit-index').value);
            const effectiveDate = document.getElementById('rateEffectiveDate').value;
            if (!effectiveDate) { showAlert('Effective Date is required.', 'error'); return; }
            const newPeriod = {
                effectiveDate,
                tonRate: parseFloat(document.getElementById('rateTonRate').value) || 0,
                restRate: parseFloat(document.getElementById('rateRestRate').value) || 0,
                layoffRate: parseFloat(document.getElementById('rateLayoffRate').value) || 0,
                wagonRate: parseFloat(document.getElementById('rateWagonRate').value) || 0,
                allowance: parseFloat(document.getElementById('rateAllowance').value) || 0,
                annualBenefits: parseFloat(document.getElementById('rateAnnualBenefits').value) || 0
            };
            if (index === -1) { appData.agreements.history.push(newPeriod); } else { appData.agreements.history[index] = newPeriod; }
            await saveUserData();
            showAlert('Rate history saved successfully!', 'success');
            loadAgreements();
        }
        
        async function deleteRatePeriod(index) {
            if (appData.agreements.history.length <= 1) { showAlert('You cannot delete the only rate period. Please edit it instead.', 'error'); return; }
            if (confirm('Are you sure you want to delete this rate period? This action cannot be undone.')) {
                appData.agreements.history.splice(index, 1);
                await saveUserData();
                showAlert('Rate period deleted.', 'success');
                loadAgreements();
            }
        }

        async function saveNewAgreement() {
            Object.keys(appData.agreements.new).forEach(key => {
                const element = document.getElementById(`new${key.charAt(0).toUpperCase() + key.slice(1)}`);
                if (element) appData.agreements.new[key] = parseFloat(element.value) || 0;
            });
            await saveUserData();
            showAlert('New Agreement details saved successfully!', 'success');
        }
        
        function loadPayPeriods() {
            const selector = document.getElementById('payPeriod'); selector.innerHTML = '<option value="">Select Period</option>';
            const today = new Date(); if (!appData.configs || !appData.configs.agreementStartDate) return;
            const agreementStart = new Date(appData.configs.agreementStartDate + "T00:00:00");
            let loopDate = new Date(agreementStart.getFullYear(), agreementStart.getMonth(), 1); let optionsHtml = '';
            while (loopDate <= today) {
                const year = loopDate.getFullYear(), month = (loopDate.getMonth() + 1).toString().padStart(2, '0');
                const monthName = loopDate.toLocaleString('default', { month: 'long' });
                const lastDay = new Date(year, loopDate.getMonth() + 1, 0).getDate();
                optionsHtml = `<option value="${year}-${month}-16,${year}-${month}-${lastDay}">${monthName} ${year} (16-${lastDay})</option>` + optionsHtml;
                optionsHtml = `<option value="${year}-${month}-01,${year}-${month}-15">${monthName} ${year} (1-15)</option>` + optionsHtml;
                loopDate.setMonth(loopDate.getMonth() + 1);
            }
            selector.innerHTML += optionsHtml;
            // CORRECTED: Logic to set the current pay period as default
            const currentDay = today.getDate(), currentYear = today.getFullYear(), currentMonth = (today.getMonth() + 1).toString().padStart(2, '0');
            const lastDayOfMonth = new Date(currentYear, today.getMonth() + 1, 0).getDate();
            let defaultValue = (currentDay <= 15) ? `${currentYear}-${currentMonth}-01,${currentYear}-${currentMonth}-15` : `${currentYear}-${currentMonth}-16,${currentYear}-${currentMonth}-${lastDayOfMonth}`;
            if (selector.querySelector(`option[value="${defaultValue}"]`)) selector.value = defaultValue;
        }

        function generateSalaryReport() {
            const period = document.getElementById('payPeriod').value;
            if (!period) { showAlert('Please select a pay period', 'error'); return; }
            const [startDate, endDate] = period.split(',');
            const salaryData = calculatePeriodSalary(startDate, endDate);
            displaySalaryReport(salaryData, startDate, endDate);
            displayDetailedSalaryTable(startDate, endDate);
        }
        
        function calculatePeriodSalary(startDate, endDate) {
            const salaryData = {}; appData.workers.forEach(w => salaryData[w] = 0);
            Object.keys(appData.salaries || {}).filter(d => d >= startDate && d <= endDate).forEach(d => {
                if (appData.salaries[d].earnings) {
                    Object.keys(appData.salaries[d].earnings).forEach(w => { if(salaryData[w] !== undefined) salaryData[w] += appData.salaries[d].earnings[w]; });
                }
            });
            const ratesForPeriod = getRatesForDate(endDate);
            const allowanceForPeriod = ratesForPeriod.allowance / 2;
            appData.workers.forEach(w => { if(salaryData[w] !== undefined) salaryData[w] += allowanceForPeriod; });
            return salaryData;
        }
        
        function displaySalaryReport(data, startDate, endDate) {
            const container = document.getElementById('salaryResults');
            const viewableWorkers = appData.permissions?.viewableWorkers || [];
            let html = `<h3>Salary Report: ${startDate} to ${endDate}</h3><div class="report-grid">`;
            appData.workers.forEach(worker => {
                if (viewableWorkers.includes(worker)) html += `<div class="report-card"><strong>${worker}</strong><br>Rs. ${(data[worker] || 0).toFixed(2)}</div>`;
                else html += `<div class="report-card" style="background:#f1f1f1;border-left-color:#a0a0a0;"><strong>${worker}</strong><br><span style="color:#6200EE;font-weight:500;">Contact admin to view details</span></div>`;
            });
            html += `</div>`; container.innerHTML = html;
        }

        function displayDetailedSalaryTable(startDate, endDate) {
            const container = document.getElementById('salaryResults');
            const periodEntries = Object.values(appData.salaries || {}).filter(e => e.date >= startDate && e.date <= endDate).sort((a, b) => new Date(a.date) - new Date(b.date));
            let tableHtml = `<div class="history-table-container" style="margin-top: 24px;"><h3>Detailed Entries</h3>`;
            if (periodEntries.length === 0) { tableHtml += `<p class="no-history">No entries found.</p></div>`; container.innerHTML += tableHtml; return; }
            tableHtml += `<div class="history-table-wrapper"><table class="history-table"><thead><tr><th>Date</th><th>Tonnage</th>${appData.configs.isWagonRateEnabled ? '<th>Wagons</th>' : ''}<th>Absent</th><th>Pay/Worker (Rs)</th></tr></thead><tbody>`;
            periodEntries.forEach(entry => {
                const absentWorkers = appData.workers.filter(w => !entry.presentWorkers.includes(w)).join(', ') || 'None';
                let singlePay = 0;
                if (entry.presentWorkers?.length > 0) singlePay = entry.earnings[entry.presentWorkers[0]] || 0;
                else if (entry.type === 'rest') singlePay = getRatesForDate(entry.date).restRate;
                else if (appData.workers?.length > 0) singlePay = entry.earnings[appData.workers[0]] || 0;
                tableHtml += `<tr><td>${entry.date}</td><td>${entry.type === 'rest' ? 'Rest Day' : (entry.tonnage > 0 ? entry.tonnage.toFixed(2) : '-')}</td>${appData.configs.isWagonRateEnabled ? `<td>${entry.wagons > 0 ? entry.wagons : '-'}</td>` : ''}<td>${absentWorkers}</td><td>${singlePay.toFixed(2)}</td></tr>`;
            });
            tableHtml += `</tbody></table></div></div>`; container.innerHTML += tableHtml;
        }

        function loadFiscalYears() {
            const b = document.getElementById('fiscalYear'), l = document.getElementById('leavesFiscalYear');
            if (!appData.configs || !appData.configs.agreementStartDate) return;
            if(b) b.innerHTML = '<option value="">Select Year</option>'; if(l) l.innerHTML = '<option value="">Select Year</option>';
            const [fm, fd] = appData.configs.fiscalYearStart.split('-').map(Number);
            const currentYear = new Date().getFullYear(); let optionsHtml = '';
            for (let i = 0; i < 5; i++) {
                const startYear = currentYear - i;
                optionsHtml += `<option value="${startYear}-${String(fm).padStart(2, '0')}-${String(fd).padStart(2, '0')}">${startYear}-${startYear + 1}</option>`;
            }
            if(b) b.innerHTML += optionsHtml; if(l) l.innerHTML += optionsHtml;
            // CORRECTED: Logic to set the last COMPLETED fiscal year as default
            const today = new Date();
            let lastCompletedFiscalYearStart = getCurrentFiscalYearDates(today.toISOString().split('T')[0])[0];
            if (today >= lastCompletedFiscalYearStart) {
                // We are in the current fiscal year, so the last completed one started last year.
                lastCompletedFiscalYearStart.setFullYear(lastCompletedFiscalYearStart.getFullYear() - 1);
            } else {
                // We are still in the period before the current fiscal year has started, so the last completed one started two years ago.
                lastCompletedFiscalYearStart.setFullYear(lastCompletedFiscalYearStart.getFullYear() - 2);
            }
            const defaultValue = `${lastCompletedFiscalYearStart.getFullYear()}-${String(fm).padStart(2, '0')}-${String(fd).padStart(2, '0')}`;
            if(b && b.querySelector(`option[value="${defaultValue}"]`)) b.value = defaultValue;
            if(l && l.querySelector(`option[value="${defaultValue}"]`)) l.value = defaultValue;
        }
        
        function calculateBonus() { 
            const f = document.getElementById('fiscalYear').value; 
            if (!f) { showAlert('Please select a fiscal year', 'error'); return; } 
            displayBonusReport(calculateAnnualBonus(f), f); 
        }

        function calculateTotalAllowanceForPeriod(startDate, endDate) {
            let totalAllowance = 0; let currentDate = new Date(startDate);
            while (currentDate <= endDate) {
                totalAllowance += getRatesForDate(currentDate.toISOString().split('T')[0]).allowance;
                currentDate.setMonth(currentDate.getMonth() + 1);
            }
            return totalAllowance;
        }

        function calculateAnnualBonus(fiscalYearStartDateString) {
            const fiscalStart = new Date(fiscalYearStartDateString);
            const fiscalEnd = new Date(fiscalStart); fiscalEnd.setFullYear(fiscalEnd.getFullYear() + 1); fiscalEnd.setDate(fiscalEnd.getDate() - 1);
            const workerBonusData = {};
            appData.workers.forEach(workerName => {
                let annualWorkEarnings = 0, totalLeaves = 0; 
                Object.values(appData.salaries || {}).forEach(entry => {
                    const entryDate = new Date(entry.date + "T00:00:00");
                    if (entryDate >= fiscalStart && entryDate <= fiscalEnd) {
                        if (entry.earnings && entry.earnings[workerName] !== undefined) annualWorkEarnings += entry.earnings[workerName];
                        if (entry.type !== 'rest' && !entry.presentWorkers.includes(workerName)) totalLeaves++;
                    }
                });
                const totalAnnualAllowance = calculateTotalAllowanceForPeriod(fiscalStart, fiscalEnd);
                const totalAnnualEarnings = annualWorkEarnings + totalAnnualAllowance;
                const avgMonthlySalary = totalAnnualEarnings / 12;
                const bonus = avgMonthlySalary; const gratuity = avgMonthlySalary;
                const ratesAtYearEnd = getRatesForDate(fiscalEnd.toISOString().split('T')[0]);
                const unpaidLeaves = appData.configs.unpaidLeaves || 20;
                const paidLeaves = appData.configs.paidLeaves || 12;
                const paidLeavesUsed = Math.min(Math.max(totalLeaves - unpaidLeaves, 0), paidLeaves);
                const remainingPaidLeaves = paidLeaves - paidLeavesUsed;
                const paidLeavesBonus = remainingPaidLeaves * ratesAtYearEnd.layoffRate;
                const totalBonus = bonus + gratuity + paidLeavesBonus;
                workerBonusData[workerName] = { annualEarnings: totalAnnualEarnings, avgMonthlySalary, bonus, gratuity, paidLeavesBonus, totalBonus };
            });
            return workerBonusData;
        }

        function displayBonusReport(b, f) {
            const c = document.getElementById('bonusResults'), v = appData.permissions?.viewableWorkers || [], s = new Date(f).getFullYear(); let h = `<h3>Annual Bonus Report: ${s}-${s + 1}</h3><div class="report-grid">`; appData.workers.forEach(w => { if (v.includes(w)) { const d=b[w]||{}; h += `<div class="report-card"><strong>${w}</strong><br>Annual Earnings: Rs. ${(d.annualEarnings||0).toFixed(2)}<br>Avg Monthly: Rs. ${(d.avgMonthlySalary||0).toFixed(2)}<br>Bonus: Rs. ${(d.bonus||0).toFixed(2)}<br>Gratuity: Rs. ${(d.gratuity||0).toFixed(2)}<br>Paid Leaves Bonus: Rs. ${(d.paidLeavesBonus||0).toFixed(2)}<br><strong>Total Bonus: Rs. ${(d.totalBonus||0).toFixed(2)}</strong></div>`; } else { h += `<div class="report-card" style="background:#f1f1f1;border-left-color:#a0a0a0;"><strong>${w}</strong><br><span style="color:#6200EE;font-weight:500;">Contact admin to view details</span></div>`; } }); h += `</div>`; c.innerHTML = h;
        }

        function calculateArrears() { 
            const c = document.getElementById('arrearsResults'); 
            c.innerHTML = '<div class="loading"><div class="spinner"></div><p>Calculating arrears...</p></div>'; 
            setTimeout(() => displayArrearsReport(calculateAllArrears()), 500); 
        }

        function calculateAllArrears() {
            const agreementStartDate = new Date(appData.configs.agreementStartDate + "T00:00:00");
            const today = new Date(); today.setHours(0, 0, 0, 0);
            const arrearsByWorker = {};
            appData.workers.forEach(w => { arrearsByWorker[w] = { salaryArrears: 0, allowanceArrears: 0, bonusArrears: 0, annualBenefitsArrears: 0, totalArrears: 0 }; });

            Object.values(appData.salaries || {}).forEach(entry => {
                const entryDate = new Date(entry.date + "T00:00:00");
                if (entryDate >= agreementStartDate && entryDate <= today) {
                    const ratesHistoric = getRatesForDate(entry.date);
                    const earningsHistoric = calculateDayEarnings(entry.date, entry.type, entry.tonnage, entry.wagons, entry.presentWorkers, ratesHistoric);
                    const earningsNew = calculateDayEarnings(entry.date, entry.type, entry.tonnage, entry.wagons, entry.presentWorkers, appData.agreements.new);
                    appData.workers.forEach(w => { arrearsByWorker[w].salaryArrears += ((earningsNew[w] || 0) - (earningsHistoric[w] || 0)); });
                }
            });

            // CORRECTED ALLOWANCE ARREARS LOGIC
            let totalAllowanceArrears = 0;
            let loopDate = new Date(agreementStartDate);
            while (loopDate.getFullYear() < today.getFullYear() || (loopDate.getFullYear() === today.getFullYear() && loopDate.getMonth() < today.getMonth())) {
                const ratesHistoric = getRatesForDate(loopDate.toISOString().split('T')[0]);
                totalAllowanceArrears += (appData.agreements.new.allowance - ratesHistoric.allowance);
                loopDate.setMonth(loopDate.getMonth() + 1);
            }
            if (loopDate.getFullYear() === today.getFullYear() && loopDate.getMonth() === today.getMonth()) {
                const ratesHistoric = getRatesForDate(today.toISOString().split('T')[0]);
                const allowanceDiff = appData.agreements.new.allowance - ratesHistoric.allowance;
                if (today.getDate() >= 16) totalAllowanceArrears += allowanceDiff;
                else totalAllowanceArrears += (allowanceDiff / 2);
            }
            appData.workers.forEach(w => { arrearsByWorker[w].allowanceArrears = totalAllowanceArrears; });
            
            const [fm, fd] = appData.configs.fiscalYearStart.split('-').map(Number);
            let fiscalYearStart = getCurrentFiscalYearDates(appData.configs.agreementStartDate)[0];
            while (true) {
                let fiscalYearEnd = new Date(fiscalYearStart); fiscalYearEnd.setFullYear(fiscalYearEnd.getFullYear() + 1); fiscalYearEnd.setDate(fiscalYearEnd.getDate() - 1);
                if (fiscalYearEnd > today) break;
                const fiscalYearString = `${fiscalYearStart.getFullYear()}-${String(fm).padStart(2, '0')}-${String(fd).padStart(2, '0')}`;
                const bonusCurrent = calculateAnnualBonus(fiscalYearString);
                const bonusNew = calculateAnnualBonusWithRates(fiscalYearString, appData.agreements.new);
                appData.workers.forEach(w => { arrearsByWorker[w].bonusArrears += ((bonusNew[w]?.totalBonus || 0) - (bonusCurrent[w]?.totalBonus || 0)); });
                fiscalYearStart.setFullYear(fiscalYearStart.getFullYear() + 1);
            }

            let totalBenefitsArrears = 0; let benefitsLoopDate = new Date(agreementStartDate);
            while(benefitsLoopDate <= today) {
                const ratesHistoric = getRatesForDate(benefitsLoopDate.toISOString().split('T')[0]);
                totalBenefitsArrears += (appData.agreements.new.annualBenefits - ratesHistoric.annualBenefits);
                benefitsLoopDate.setMonth(benefitsLoopDate.getMonth() + 1);
            }
            appData.workers.forEach(w => { arrearsByWorker[w].annualBenefitsArrears = totalBenefitsArrears / 12; });

            appData.workers.forEach(w => {
                const d = arrearsByWorker[w];
                d.totalArrears = d.salaryArrears + d.allowanceArrears + d.bonusArrears + d.annualBenefitsArrears;
            });
            return arrearsByWorker;
        }

        function calculateAnnualBonusWithRates(fiscalYearStartDateString, newRates) {
            const fiscalStart = new Date(fiscalYearStartDateString), fiscalEnd = new Date(fiscalStart); fiscalEnd.setFullYear(fiscalEnd.getFullYear() + 1); fiscalEnd.setDate(fiscalEnd.getDate() - 1);
            const workerBonusData = {};
            appData.workers.forEach(workerName => {
                let annualWorkEarnings = 0, totalLeaves = 0;
                Object.values(appData.salaries || {}).forEach(entry => {
                    const entryDate = new Date(entry.date + "T00:00:00");
                    if (entryDate >= fiscalStart && entryDate <= fiscalEnd) {
                        const dailyEarning = calculateDayEarnings(entry.date, entry.type, entry.tonnage, entry.wagons, entry.presentWorkers, newRates);
                        annualWorkEarnings += dailyEarning[workerName] || 0;
                        if (entry.type !== 'rest' && !entry.presentWorkers.includes(workerName)) totalLeaves++;
                    }
                });
                const totalAnnualAllowance = newRates.allowance * 12;
                const totalAnnualEarnings = annualWorkEarnings + totalAnnualAllowance;
                const avgMonthlySalary = totalAnnualEarnings / 12;
                const bonus = avgMonthlySalary; const gratuity = avgMonthlySalary;
                const paidLeavesUsed = Math.min(Math.max(totalLeaves - (appData.configs.unpaidLeaves || 20), 0), (appData.configs.paidLeaves || 12));
                const remainingPaidLeaves = (appData.configs.paidLeaves || 12) - paidLeavesUsed;
                const paidLeavesBonus = remainingPaidLeaves * newRates.layoffRate;
                workerBonusData[workerName] = { totalBonus: bonus + gratuity + paidLeavesBonus };
            });
            return workerBonusData;
        }

        function displayArrearsReport(a) {
            const c = document.getElementById('arrearsResults'), v = appData.permissions?.viewableWorkers || []; let h = `<h3>Arrears Calculation Report</h3><p>From Agreement Start Date: ${appData.configs.agreementStartDate}</p><div class="report-grid">`; appData.workers.forEach(w => { if (v.includes(w)) { const d=a[w]||{}; h+=`<div class="report-card"><strong>${w}</strong><br>Salary Arrears: Rs. ${(d.salaryArrears||0).toFixed(2)}<br>Allowance Arrears: Rs. ${(d.allowanceArrears||0).toFixed(2)}<br>Bonus Arrears: Rs. ${(d.bonusArrears||0).toFixed(2)}<br>Annual Benefits Arrears: Rs. ${(d.annualBenefitsArrears||0).toFixed(2)}<br><strong>Total Arrears: Rs. ${(d.totalArrears||0).toFixed(2)}</strong></div>`;} else {h+=`<div class="report-card" style="background:#f1f1f1;border-left-color:#a0a0a0;"><strong>${w}</strong><br><span style="color:#6200EE;font-weight:500;">Contact admin to view details</span></div>`;}}); h+=`</div>`; c.innerHTML = h;
        }
        
        function calculateAndDisplayPeriodArrears() {
            const startDate = document.getElementById('periodArrearsStartDate').value;
            const endDate = document.getElementById('periodArrearsEndDate').value;
            if (!startDate || !endDate || new Date(startDate) > new Date(endDate)) { showAlert('Please select a valid start and end date.', 'error'); return; }
            const resultsContainer = document.getElementById('periodArrearsResults');
            resultsContainer.innerHTML = '<div class="loading"><div class="spinner"></div></div>'; 
            setTimeout(() => {
                const periodArrears = calculateArrearsForPeriod(startDate, endDate);
                displayPeriodArrears(periodArrears, startDate, endDate);
            }, 500);
        }

        function calculateArrearsForPeriod(startDateStr, endDateStr) {
            const startDate = new Date(startDateStr + "T00:00:00");
            const endDate = new Date(endDateStr + "T00:00:00");
            const arrearsByWorker = {}; appData.workers.forEach(w => arrearsByWorker[w] = { salaryArrears: 0, allowanceArrears: 0, totalArrears: 0 });
            Object.values(appData.salaries || {}).filter(e => e.date >= startDateStr && e.date <= endDateStr).forEach(entry => {
                const ratesHistoric = getRatesForDate(entry.date);
                const earningsHistoric = calculateDayEarnings(entry.date, entry.type, entry.tonnage, entry.wagons, entry.presentWorkers, ratesHistoric);
                const earningsNew = calculateDayEarnings(entry.date, entry.type, entry.tonnage, entry.wagons, entry.presentWorkers, appData.agreements.new);
                appData.workers.forEach(w => { arrearsByWorker[w].salaryArrears += ((earningsNew[w] || 0) - (earningsHistoric[w] || 0)); });
            });
            let totalAllowanceArrears = 0; let loopDate = new Date(startDate);
            while (loopDate.getFullYear() < endDate.getFullYear() || (loopDate.getFullYear() === endDate.getFullYear() && loopDate.getMonth() < endDate.getMonth())) {
                const ratesHistoric = getRatesForDate(loopDate.toISOString().split('T')[0]);
                totalAllowanceArrears += (appData.agreements.new.allowance - ratesHistoric.allowance);
                loopDate.setMonth(loopDate.getMonth() + 1);
            }
            if (loopDate.getFullYear() === endDate.getFullYear() && loopDate.getMonth() === endDate.getMonth()) {
                const ratesHistoric = getRatesForDate(endDate.toISOString().split('T')[0]);
                const allowanceDiff = appData.agreements.new.allowance - ratesHistoric.allowance;
                if (endDate.getDate() >= 16) { totalAllowanceArrears += allowanceDiff; } else { totalAllowanceArrears += (allowanceDiff / 2); }
            }
            appData.workers.forEach(w => { arrearsByWorker[w].allowanceArrears = totalAllowanceArrears; });
            appData.workers.forEach(w => { arrearsByWorker[w].totalArrears = arrearsByWorker[w].salaryArrears + arrearsByWorker[w].allowanceArrears; });
            return arrearsByWorker;
        }

        function displayPeriodArrears(arrearsData, startDate, endDate) {
            const container = document.getElementById('periodArrearsResults');
            const viewableWorkers = appData.permissions?.viewableWorkers || [];
            let html = `<h3>Arrears Report for ${startDate} to ${endDate}</h3><p class="no-history">Note: This calculation only includes Salary and Monthly Allowance arrears.</p><div class="report-grid">`;
            appData.workers.forEach(worker => {
                const data = arrearsData[worker] || {};
                if (viewableWorkers.includes(worker)) html += `<div class="report-card"><strong>${worker}</strong><br>Salary Arrears: Rs. ${(data.salaryArrears || 0).toFixed(2)}<br>Allowance Arrears: Rs. ${(data.allowanceArrears || 0).toFixed(2)}<br><strong>Total Arrears for Period: Rs. ${(data.totalArrears || 0).toFixed(2)}</strong></div>`;
                else html += `<div class="report-card" style="background:#f1f1f1;border-left-color:#a0a0a0;"><strong>${worker}</strong><br><span style="color:#6200EE;font-weight:500;">Contact admin to view details</span></div>`;
            });
            html += `</div>`; container.innerHTML = html;
        }
        
        function generateLeavesReport() { const f = document.getElementById('leavesFiscalYear').value; if(!f){showAlert('Please select a fiscal year','error'); return;} displayLeavesReport(calculateLeavesReport(f), f); }
        
        function calculateLeavesReport(f) {
            const s = new Date(f), e = new Date(s); e.setFullYear(e.getFullYear() + 1); e.setDate(e.getDate() - 1);
            const w = {}; const unpaidLeavesConfig = appData.configs.unpaidLeaves || 20;
            const paidLeavesConfig = appData.configs.paidLeaves || 12; const totalLeavesConfig = unpaidLeavesConfig + paidLeavesConfig;
            appData.workers.forEach(b => {
                let t = 0, d = 0;
                Object.entries(appData.salaries || {}).forEach(([dt, en]) => {
                    const ed = new Date(dt + "T00:00:00");
                    if (ed >= s && ed <= e) { if (en.type === 'work' || en.type === 'special_overtime') { if (en.presentWorkers.includes(b)) d++; else t++; } }
                });
                const u = Math.min(t, unpaidLeavesConfig); const p = Math.min(Math.max(t - unpaidLeavesConfig, 0), paidLeavesConfig);
                const x = Math.max(t - totalLeavesConfig, 0); const R = paidLeavesConfig - p;
                w[b] = { totalLeaves: t, unpaidLeaves: u, paidLeaves: p, excessLeaves: x, remainingPaidLeaves: R, workDays: d };
            });
            return w;
        }
        
        function displayLeavesReport(l,f){
            const c=document.getElementById('leavesResults'),v=appData.permissions?.viewableWorkers||[],s=new Date(f).getFullYear();
            const unpaid = appData.configs.unpaidLeaves || 20; const paid = appData.configs.paidLeaves || 12; const total = unpaid + paid;
            let h=`<h3>Leaves Report: ${s}-${s+1}</h3><div class="alert alert-info"><strong>Leave Structure:</strong> ${unpaid} Unpaid Leaves + ${paid} Paid Leaves = ${total} Total Annual Leaves</div><div class="report-grid">`;
            appData.workers.forEach(w=>{
                if(v.includes(w)){
                    const d=l[w]||{};
                    h+=`<div class="report-card"><strong>${w}</strong><br>Work Days: ${d.workDays||0}<br>Total Leaves: ${d.totalLeaves||0}<br>Unpaid Leaves: ${d.unpaidLeaves||0}/${unpaid}<br>Paid Leaves Used: ${d.paidLeaves||0}/${paid}<br>Remaining Paid: ${d.remainingPaidLeaves||0}<br>${(d.excessLeaves||0)>0?`<span style="color:#e53e3e;">Excess Leaves: ${d.excessLeaves}</span>`:''}</div>`;
                } else { h+=`<div class="report-card" style="background:#f1f1f1;border-left-color:#a0a0a0;"><strong>${w}</strong><br><span style="color:#6200EE;font-weight:500;">Contact admin to view details</span></div>`; }
            });
            h+='</div>'; c.innerHTML=h;
        }
        
        function loadSettings() {
            if (!appData.configs) return;
            document.getElementById('workerCount').value = appData.configs.workerCount;
            document.getElementById('agreementStartDate').value = appData.configs.agreementStartDate;
            document.getElementById('fiscalYearStart').value = appData.configs.fiscalYearStart;
            document.getElementById('unpaidLeaves').value = appData.configs.unpaidLeaves || 20;
            document.getElementById('paidLeaves').value = appData.configs.paidLeaves || 12;
            document.getElementById('enableWagonRate').checked = appData.configs.isWagonRateEnabled;
            document.getElementById('enablePenalty').checked = appData.configs.isPenaltyEnabled;
            document.getElementById('penaltyAmount').value = appData.configs.penaltyAmount;
            document.getElementById('penaltyAmountContainer').style.display = appData.configs.isPenaltyEnabled ? 'block' : 'none';
            toggleWagonUIElements(appData.configs.isWagonRateEnabled);
            document.getElementById('unlock-prompt').style.display = 'block';
            document.getElementById('worker-management-buttons').style.display = 'none';
            document.getElementById('unlock-key-input').value = '';
            isWorkerSettingsLocked = true; loadWorkersList();
        }

        function loadWorkersList() {
            const container = document.getElementById('workersList'); const managementContainer = document.getElementById('worker-management-buttons'); container.innerHTML = '';
            (appData.workers || []).forEach((worker, index) => {
                const div = document.createElement('div'); div.className = 'form-group'; const disabledAttr = isWorkerSettingsLocked ? 'disabled' : '';
                div.innerHTML = `<label>Worker ${index+1}:</label><div style="display:flex;gap:10px;"><input type="text" value="${worker}" onchange="updateWorkerName(${index}, this.value)" style="flex:1;" ${disabledAttr}><button onclick="removeWorker(${index})" class="btn btn-danger" style="padding:8px 12px;${isWorkerSettingsLocked?'display:none;':''}">Remove</button></div>`;
                container.appendChild(div);
            });
            if (!isWorkerSettingsLocked) {
                managementContainer.innerHTML = `<button onclick="addWorker()" class="btn btn-success">Add Worker</button>`;
            } else {
                managementContainer.innerHTML = `<button onclick="unlockWorkerSettings()" class="btn">Unlock Worker Settings</button>`;
            }
        }

        function unlockWorkerSettings() {
            if (confirm("TANBEEH (WARNING)!\n\nWorker ke naam ya taadad tabdeel karne se purane hisaab kitab (calculations), reports, aur data par asar par sakta hai.\n\nKya aap waqai aage barhna chahte hain?")) {
                isWorkerSettingsLocked = false; loadWorkersList();
            }
        }
        
        async function addWorker() { if (!appData.workers) appData.workers = []; appData.workers.push(`Worker ${appData.workers.length + 1}`); loadWorkersList(); loadWorkerAttendance(); }
        async function removeWorker(index) { if (appData.workers.length <= 1) { showAlert('Kam se kam ek worker zaroori hai.', 'error'); return; } appData.workers.splice(index, 1); loadWorkersList(); loadWorkerAttendance(); }
        async function updateWorkerName(index, newName) { if (newName.trim()) appData.workers[index] = newName.trim(); }
        
        async function saveSettings() {
            if (!isWorkerSettingsLocked) {
                const workerInputs = document.querySelectorAll('#workersList input[type="text"]'), newWorkerNames = [];
                workerInputs.forEach(input => newWorkerNames.push(input.value));
                appData.workers = newWorkerNames; appData.configs.workerCount = newWorkerNames.length;
            }
            const agreementDateValue = document.getElementById('agreementStartDate').value;
            if (agreementDateValue) {
                const agreementDate = new Date(agreementDateValue + "T00:00:00");
                const fiscalMonth = (agreementDate.getMonth() + 1).toString().padStart(2, '0');
                const fiscalDay = agreementDate.getDate().toString().padStart(2, '0');
                appData.configs.fiscalYearStart = `${fiscalMonth}-${fiscalDay}`;
                document.getElementById('fiscalYearStart').value = appData.configs.fiscalYearStart;
            }
            appData.configs.agreementStartDate = agreementDateValue;
            appData.configs.isWagonRateEnabled = document.getElementById('enableWagonRate').checked;
            appData.configs.isPenaltyEnabled = document.getElementById('enablePenalty').checked;
            appData.configs.penaltyAmount = parseFloat(document.getElementById('penaltyAmount').value) || 231;
            appData.configs.unpaidLeaves = parseInt(document.getElementById('unpaidLeaves').value) || 20;
            appData.configs.paidLeaves = parseInt(document.getElementById('paidLeaves').value) || 12;
            await saveUserData();
            showAlert('Settings saved successfully!', 'success');
            isWorkerSettingsLocked = true; loadSettings(); loadFiscalYears(); 
        }

        // CORRECTED: This function now ONLY unhides the button.
        function checkUnlockKey() {
            const inputField = document.getElementById('unlock-key-input');
            const correctPhrase = "unlock worker settings ke button ko unhide karo";
            if (inputField.value.trim() === correctPhrase) {
                document.getElementById('worker-management-buttons').style.display = 'block';
                document.getElementById('unlock-prompt').style.display = 'none';
            } else { showAlert('Aapne sahi jumla type nahi kiya. Dobara koshish karein.', 'error'); }
        }

		function showAlert(message, type = 'info') {
            document.querySelectorAll('.alert').forEach(a => a.remove());
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`; alertDiv.textContent = message;
            document.body.appendChild(alertDiv);
            setTimeout(() => {
                alertDiv.style.transition = 'opacity 0.5s ease, bottom 0.5s ease';
                alertDiv.style.opacity = '0'; alertDiv.style.bottom = '0px';
                setTimeout(() => alertDiv.remove(), 500);
            }, 5000);
        }
    </script>
</body>
</html>
